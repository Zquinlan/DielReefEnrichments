group_by(DayNight)%>%
nest()%>%
mutate(anova = map(data, ~aov(cells_ul ~ Organism, data = .x)%>%
tidy()),
dunnet = map(data, ~DunnettTest(cells_ul ~ Organism, data = .x, control = 'Water control')))
sgrAnova <- fcm_23%>%
filter(!Organism %like any% c('Influent', 'Offshore'))%>%
group_by(DayNight)%>%
nest()%>%
mutate(anova = map(data, ~aov(cells_ul ~ Organism, data = .x)%>%
tidy()),
dunnet = map(data, ~DunnettTest(cells_ul, Organism, data = .x, control = 'Water control')))
sgrAnova <- fcm_23%>%
filter(!Organism %like any% c('Influent', 'Offshore'))%>%
group_by(DayNight)%>%
nest()%>%
mutate(anova = map(data, ~aov(cells_ul ~ Organism, data = .x)%>%
tidy()),
dunnet = map(data, ~DunnettTest(cells_ul ~ Organism, data = .x)))
?TukeyHSD
sgrAnova <- fcm_23%>%
filter(!Organism %like any% c('Influent', 'Offshore'))
DunnettTest(sgrAnova$cells_ul, sgrAnova$Organism)
sgrAnova <- fcm_23%>%
filter(!Organism %like any% c('Influent', 'Offshore'))%>%
mutate(Organism = as.factor(Organism))%>%
group_by(DayNight)%>%
nest()%>%
mutate(anova = map(data, ~aov(cells_ul ~ Organism, data = .x)%>%
tidy()),
dunnet = map(data, ~DunnettTest(cells_ul ~ Organism, data = .x)))
sgrAnova$dunnet
fcm_23$Organism%>% unique()
sgrAnova <- dorc_fcm_fdom%>%
select(-c(1:4, 9:36, 38, 39))%>%
spread(Timepoint, `Cells µL-1`)%>%
mutate(hour = 24,
final_cells = T4)%>%
group_by(Organism, DayNight)%>%
mutate(T0 = mean(T0, na.rm = TRUE),
cells_ul = (log(final_cells - T0))/(hour))%>%
select(-c(T0:TF, hour))%>%
left_join(metabolitePool_labileChange,  by = c('Organism', 'DayNight', 'Replicate'))%>%
mutate(log10 = log10(abs(difference)))%>%
filter(Organism != 'Influent',
Organism != 'Offshore')
sgrAnova <- dorc_fcm_fdom%>%
select(-c(1:4, 9:36, 38, 39))%>%
spread(Timepoint, `Cells µL-1`)%>%
mutate(hour = 24,
final_cells = T4)%>%
group_by(Organism, DayNight)%>%
mutate(T0 = mean(T0, na.rm = TRUE),
cells_ul = (log(final_cells - T0))/(hour))%>%
select(-c(T0:TF, hour))%>%
left_join(metabolitePool_labileChange,  by = c('Organism', 'DayNight', 'Replicate'))%>%
mutate(log10 = log10(abs(difference)))%>%
filter(Organism != 'Influent',
Organism != 'Offshore')%>%
# filter(!Organism %like any% c('Influent', 'Offshore'))%>%
mutate(Organism = as.factor(Organism))%>%
group_by(DayNight)%>%
nest()%>%
mutate(anova = map(data, ~aov(cells_ul ~ Organism, data = .x)%>%
tidy()),
dunnet = map(data, ~DunnettTest(cells_ul ~ Organism, data = .x)))
sgrAnova$dunnet
sgrAnova <- dorc_fcm_fdom%>%
select(-c(1:4, 9:36, 38, 39))%>%
spread(Timepoint, `Cells µL-1`)%>%
mutate(hour = 24,
final_cells = T4)%>%
group_by(Organism, DayNight)%>%
mutate(T0 = mean(T0, na.rm = TRUE),
cells_ul = (log(final_cells - T0))/(hour))%>%
select(-c(T0:TF, hour))%>%
left_join(metabolitePool_labileChange,  by = c('Organism', 'DayNight', 'Replicate'))%>%
mutate(log10 = log10(abs(difference)))%>%
filter(Organism != 'Influent',
Organism != 'Offshore')%>%
# filter(!Organism %like any% c('Influent', 'Offshore'))%>%
mutate(Organism = as.factor(Organism),
Organism = fct_relevel(Organism, 'Water control'))%>%
group_by(DayNight)%>%
nest()%>%
mutate(anova = map(data, ~aov(cells_ul ~ Organism, data = .x)%>%
tidy()),
dunnet = map(data, ~DunnettTest(cells_ul ~ Organism, data = .x)))
sgrAnova$dunnet
sgr_stats
sgr_stats <- fcm_23%>%
filter(!Organism %like any% c('Influent', 'Water control', 'Offshore'))%>%
group_by(Organism)%>%
nest()%>%
mutate(data = map(data, ~t.test(cells_ul ~ DayNight, .x)["p.value"][[1]]))%>%
unnest(data)%>%
mutate(test = 'sgr')
sgr_stats
xic_tukey
#   group_by(Organism)%>%
#   nest()%>%
#   mutate(p = map(data, ~ lm(log10 ~ DayNight, .x)%>%
#                    lmp()))%>%
#   # select(-data)%>%
#   # unnest(c(DayDepletion, NightDepletion))%>%
#   # gather(test, p, 2:3)%>%
#   mutate(fdr = p.adjust(p, method = 'BH'))
#
#
xic_tukey <- metabolitePool_xic_change%>%
filter(activity == 'labile')%>%
select(-c(network:ra))%>%
spread(Timepoint, xic)%>%
group_by(Organism, DayNight)%>%
mutate(T0 = mean(T0, na.rm = TRUE),
difference = TF-T0,
log10Difference = log10(abs(difference)))%>%
ungroup()%>%
group_by(DayNight)%>%
nest()%>%
mutate(data = map(data, ~ aov(log10Difference ~ Organism, .x)%>%
TukeyHSD()%>%
tidy()))%>%
unnest(data)
xic_tukey
#   group_by(Organism)%>%
#   nest()%>%
#   mutate(p = map(data, ~ lm(log10 ~ DayNight, .x)%>%
#                    lmp()))%>%
#   # select(-data)%>%
#   # unnest(c(DayDepletion, NightDepletion))%>%
#   # gather(test, p, 2:3)%>%
#   mutate(fdr = p.adjust(p, method = 'BH'))
#
#
xic_tukey <- metabolitePool_xic_change%>%
filter(activity == 'labile')%>%
select(-c(network:ra))%>%
spread(Timepoint, xic)%>%
group_by(Organism, DayNight)%>%
mutate(T0 = mean(T0, na.rm = TRUE),
difference = TF-T0,
log10Difference = log10(abs(difference)))%>%
ungroup()%>%
aov(log10Difference ~ Organism, .x)%>%
TukeyHSD()%>%
tidy()
#   group_by(Organism)%>%
#   nest()%>%
#   mutate(p = map(data, ~ lm(log10 ~ DayNight, .x)%>%
#                    lmp()))%>%
#   # select(-data)%>%
#   # unnest(c(DayDepletion, NightDepletion))%>%
#   # gather(test, p, 2:3)%>%
#   mutate(fdr = p.adjust(p, method = 'BH'))
#
#
xic_tukey <- metabolitePool_xic_change%>%
filter(activity == 'labile')%>%
select(-c(network:ra))%>%
spread(Timepoint, xic)%>%
group_by(Organism, DayNight)%>%
mutate(T0 = mean(T0, na.rm = TRUE),
difference = TF-T0,
log10Difference = log10(abs(difference)))%>%
ungroup()%>%
aov(log10Difference ~ Organism, .)%>%
TukeyHSD()%>%
tidy()
xic_tukey
figSixstats <- groupedStatsLabile%>%
filter(!superclass_consensus %like any% c('Alk%', 'Lig%', 'Pheny%'),
!is.na(superclass_consensus))%>%
bind_rows(TICStats)%>%
group_by(test, superclass_consensus)%>%
nest()%>%
# mutate(data = map(data, ~lm(xic~group*DayNight, data = .x)%>%
#                     tidy()))%>%
# unnest(data)
mutate(data = map(data, ~ lmer(xic~group*DayNight + (1|Organism), data =., control =  lmerControl(check.nlev.gtr.1 = "ignore",
check.conv.singular = 'ignore',
check.nobs.vs.nRE = 'ignore'))%>%
car::Anova()%>%
rownames_to_column(var = 'var')%>%
select(var, `Pr(>Chisq)`)))%>%
unnest(data)
figSixstats
figSixstats <- groupedStatsLabile%>%
filter(!superclass_consensus %like any% c('Alk%', 'Lig%', 'Pheny%'),
!is.na(superclass_consensus))%>%
bind_rows(TICStats)%>%
group_by(test, superclass_consensus)%>%
nest()%>%
# mutate(data = map(data, ~lm(xic~group*DayNight, data = .x)%>%
#                     tidy()))%>%
# unnest(data)
mutate(data = map(data, ~ lmer(xic~group*DayNight + (1|Organism), data =., control =  lmerControl(check.nlev.gtr.1 = "ignore",
check.conv.singular = 'ignore',
check.nobs.vs.nRE = 'ignore'))%>%
car::Anova()%>%
rownames_to_column(var = 'var')%>%
select(var, `Pr(>Chisq)`)))%>%
unnest(data)%>%
mutate(FDR = p.adjust(`Pr(>Chisq)`, method = 'BH'))
groupedStatsLabile <- labileChange%>%
filter(Organism != 'CCA')%>%
mutate(group = ifelse(Organism %like% c('Poc%', 'Por%'), 'Coral', 'Fleshy algae'))%>%
group_by(group, Organism, Replicate, DayNight, superclass_consensus)%>%
summarize_if(is.numeric, sum, na.rm = TRUE)%>%
ungroup()%>%
# spread(DayNight, xic)%>%
# mutate(xic = Day-Night)%>%
#
mutate(xic = log10(xic + 1),
test = 'superclass')
TICStats <- labileChange%>%
filter(Organism != 'CCA')%>%
mutate(group = ifelse(Organism %like% c('Poc%', 'Por%'), 'Coral', 'Fleshy algae'))%>%
group_by(group, Organism, Replicate, DayNight)%>%
summarize_if(is.numeric, sum, na.rm = TRUE)%>%
ungroup()%>%
mutate(xic = log10(xic),
test = 'TIC')
figSixstats <- groupedStatsLabile%>%
filter(!superclass_consensus %like any% c('Alk%', 'Lig%', 'Pheny%'),
!is.na(superclass_consensus))%>%
bind_rows(TICStats)%>%
group_by(test, superclass_consensus)%>%
nest()%>%
# mutate(data = map(data, ~lm(xic~group*DayNight, data = .x)%>%
#                     tidy()))%>%
# unnest(data)
mutate(data = map(data, ~ lmer(xic~group*DayNight + (1|Organism), data =., control =  lmerControl(check.nlev.gtr.1 = "ignore",
check.conv.singular = 'ignore',
check.nobs.vs.nRE = 'ignore'))%>%
car::Anova()%>%
rownames_to_column(var = 'var')%>%
select(var, `Pr(>Chisq)`)))%>%
unnest(data)%>%
mutate(FDR = p.adjust(`Pr(>Chisq)`, method = 'BH'))
# Microbiak community dynamics
growthLoadStats <- fcm_23%>%
filter(Organism != 'CCA')%>%
mutate(group = ifelse(Organism %like% c('Poc%', 'Por%'), 'Coral', 'Fleshy algae'),
val = 'microbe')%>%
group_by(val)%>%
nest()%>%
mutate(load = map(data, ~ lmer(final_cells~group*DayNight + (1|Organism), data =., control =  lmerControl(check.nlev.gtr.1 = "ignore",
check.conv.singular = 'ignore',
check.nobs.vs.nRE = 'ignore'))%>%
car::Anova()%>%
rownames_to_column(var = 'var')%>%
select(var, `Pr(>Chisq)`)%>%
mutate(test = 'load')),
growth = map(data, ~ lmer(cells_ul~group*DayNight + (1|Organism), data =., control =  lmerControl(check.nlev.gtr.1 = "ignore",
check.conv.singular = 'ignore',
check.nobs.vs.nRE = 'ignore'))%>%
car::Anova()%>%
rownames_to_column(var = 'var')%>%
select(var, `Pr(>Chisq)`)%>%
mutate(test = 'growth')))
growthLoadPVals <- growthLoadStats%>%
select(-c(data, growth))%>%
unnest(load)%>%
bind_rows(growthLoadStats%>%
select(-c(data, load))%>%
unnest(growth))%>%
ungroup()%>%
select(-val)%>%
mutate(FDR = p.adjust(`Pr(>Chisq)`, method = 'BH'))
## Depletion ∆
depletionStats <- feature_stats_wdf%>%
left_join(networking%>%
select(feature_number, network), by = 'feature_number')%>%
mutate(net_act = case_when(network == -1 ~ -as.numeric(feature_number),
TRUE ~ network))%>%
left_join(all_activity, by = c('net_act', 'DayNight'))%>%
filter(activity == 'labile')%>%
group_by(Organism, Timepoint, activity, Replicate, DayNight)%>%
summarize_if(is.numeric, sum)%>%
ungroup()%>%
select(-c(log10:asin, network, net_act, ra))%>%
spread(Timepoint, xic)%>%
filter(Organism != 'CCA')%>%
group_by(Organism, DayNight)%>%
mutate(group = ifelse(Organism %like% c('Poc%', 'Por%'), 'Coral', 'Fleshy algae'),
T0 = mean(T0, na.rm = TRUE),
difference = abs(TF - T0),
log10Difference = log10(difference),
proportionalDiff = (TF-T0)/T0)%>%
mutate(val = 'val')%>%
group_by(val)%>%
nest()%>%
mutate(difference = map(data, ~ lmer(log10Difference~group*DayNight + (1|Organism), data =., control =  lmerControl(check.nlev.gtr.1 = "ignore",
check.conv.singular = 'ignore',
check.nobs.vs.nRE = 'ignore'))%>%
car::Anova()%>%
rownames_to_column(var = 'var')%>%
select(var, `Pr(>Chisq)`)%>%
mutate(test = 'depletion')),
proportionalDifference = map(data, ~ lmer(proportionalDiff~group*DayNight + (1|Organism), data =., control =  lmerControl(check.nlev.gtr.1 = "ignore",
check.conv.singular = 'ignore',
check.nobs.vs.nRE = 'ignore'))%>%
car::Anova()%>%
rownames_to_column(var = 'var')%>%
select(var, `Pr(>Chisq)`)%>%
mutate(test = 'proportionalDepletion')))
depletionStatsCombined <- depletionStats%>%
select(-c(data, proportionalDifference))%>%
unnest(difference)%>%
bind_rows(depletionStats%>%
select(-c(data, difference))%>%
unnest(proportionalDifference))%>%
ungroup()%>%
select(-val)%>%
depletionStatsCombined <- depletionStats%>%
select(-c(data, proportionalDifference))%>%
unnest(difference)%>%
bind_rows(depletionStats%>%
select(-c(data, difference))%>%
unnest(proportionalDifference))%>%
ungroup()%>%
select(-val)%>%
mutate(FDR = p.adjust(`Pr(>Chisq)`, method = 'BH'))
allLmerStats <- figSixstats%>%
bind_rows(growthLoadPVals, depletionStatsCombined)%>%
ungroup()%>%
# mutate(fdr = p.adjust(`Pr(>Chisq)`, method = 'BH'))
# STATS -- Org lability t-tests-------------------------------------------
org_lability_stats <- feature_stats_wdf%>%
left_join(networking%>%
select(feature_number, network), by = 'feature_number')%>%
mutate(net_act = case_when(network == -1 ~ -as.numeric(feature_number),
TRUE ~ network))%>%
left_join(all_activity, by = c('net_act', 'DayNight'))%>%
filter(activity != 'accumolite')%>%
left_join(ecoNet%>%
rename(feature_number = scan)%>%
mutate(feature_number = as.character(feature_number)), by = c('feature_number', 'network'))%>%
separate(ecoNetConsensus, c('superclass_consensus', 'class_consensus', 'subclass_consensus'), remove = FALSE, sep = ';')%>%
filter(Timepoint == 'T0',
activity == 'labile')%>%
select(-c(log10:asin, network, net_act, ecoNetConsensusScore, numberOfNodes))%>%
group_by(DayNight)%>%
nest()%>%
mutate(data = map(data, ~filter(.x, !is.na(xic))%>%
group_by(superclass_consensus, Organism, Replicate)%>%
summarize_if(is.numeric, sum, na.rm = TRUE)%>%
ungroup()
))%>%
unnest(data)%>%
spread(DayNight,xic)%>%
gather(DayNight,xic, Day:Night)
allLmerStats <- figSixstats%>%
bind_rows(growthLoadPVals, depletionStatsCombined)%>%
ungroup()%>%
# mutate(fdr = p.adjust(`Pr(>Chisq)`, method = 'BH'))
# STATS -- Org lability t-tests-------------------------------------------
org_lability_stats <- feature_stats_wdf%>%
left_join(networking%>%
select(feature_number, network), by = 'feature_number')%>%
mutate(net_act = case_when(network == -1 ~ -as.numeric(feature_number),
TRUE ~ network))%>%
left_join(all_activity, by = c('net_act', 'DayNight'))%>%
filter(activity != 'accumolite')%>%
left_join(ecoNet%>%
rename(feature_number = scan)%>%
mutate(feature_number = as.character(feature_number)), by = c('feature_number', 'network'))%>%
separate(ecoNetConsensus, c('superclass_consensus', 'class_consensus', 'subclass_consensus'), remove = FALSE, sep = ';')%>%
filter(Timepoint == 'T0',
activity == 'labile')%>%
select(-c(log10:asin, network, net_act, ecoNetConsensusScore, numberOfNodes))%>%
group_by(DayNight)%>%
nest()%>%
mutate(data = map(data, ~filter(.x, !is.na(xic))%>%
group_by(superclass_consensus, Organism, Replicate)%>%
summarize_if(is.numeric, sum, na.rm = TRUE)%>%
ungroup()
))%>%
unnest(data)%>%
spread(DayNight,xic)%>%
gather(DayNight,xic, Day:Night)
## Depletion ∆
depletionStats <- feature_stats_wdf%>%
left_join(networking%>%
select(feature_number, network), by = 'feature_number')%>%
mutate(net_act = case_when(network == -1 ~ -as.numeric(feature_number),
TRUE ~ network))%>%
left_join(all_activity, by = c('net_act', 'DayNight'))%>%
filter(activity == 'labile')%>%
group_by(Organism, Timepoint, activity, Replicate, DayNight)%>%
summarize_if(is.numeric, sum)%>%
ungroup()%>%
select(-c(log10:asin, network, net_act, ra))%>%
spread(Timepoint, xic)%>%
filter(Organism != 'CCA')%>%
group_by(Organism, DayNight)%>%
mutate(group = ifelse(Organism %like% c('Poc%', 'Por%'), 'Coral', 'Fleshy algae'),
T0 = mean(T0, na.rm = TRUE),
difference = abs(TF - T0),
log10Difference = log10(difference),
proportionalDiff = (TF-T0)/T0)%>%
mutate(val = 'val')%>%
group_by(val)%>%
nest()%>%
mutate(difference = map(data, ~ lmer(log10Difference~group*DayNight + (1|Organism), data =., control =  lmerControl(check.nlev.gtr.1 = "ignore",
check.conv.singular = 'ignore',
check.nobs.vs.nRE = 'ignore'))%>%
car::Anova()%>%
rownames_to_column(var = 'var')%>%
select(var, `Pr(>Chisq)`)%>%
mutate(test = 'depletion')),
proportionalDifference = map(data, ~ lmer(proportionalDiff~group*DayNight + (1|Organism), data =., control =  lmerControl(check.nlev.gtr.1 = "ignore",
check.conv.singular = 'ignore',
check.nobs.vs.nRE = 'ignore'))%>%
car::Anova()%>%
rownames_to_column(var = 'var')%>%
select(var, `Pr(>Chisq)`)%>%
mutate(test = 'proportionalDepletion')))
depletionStatsCombined <- depletionStats%>%
select(-c(data, proportionalDifference))%>%
unnest(difference)%>%
bind_rows(depletionStats%>%
select(-c(data, difference))%>%
unnest(proportionalDifference))%>%
ungroup()%>%
select(-val)%>%
mutate(FDR = p.adjust(`Pr(>Chisq)`, method = 'BH'))
figSixstats
allLmerStats <- figSixstats%>%
bind_rows(growthLoadPVals, depletionStatsCombined)%>%
ungroup()%>%
# mutate(fdr = p.adjust(`Pr(>Chisq)`, method = 'BH'))
# STATS -- Org lability t-tests-------------------------------------------
org_lability_stats <- feature_stats_wdf%>%
left_join(networking%>%
select(feature_number, network), by = 'feature_number')%>%
mutate(net_act = case_when(network == -1 ~ -as.numeric(feature_number),
TRUE ~ network))%>%
left_join(all_activity, by = c('net_act', 'DayNight'))%>%
filter(activity != 'accumolite')%>%
left_join(ecoNet%>%
rename(feature_number = scan)%>%
mutate(feature_number = as.character(feature_number)), by = c('feature_number', 'network'))%>%
separate(ecoNetConsensus, c('superclass_consensus', 'class_consensus', 'subclass_consensus'), remove = FALSE, sep = ';')%>%
filter(Timepoint == 'T0',
activity == 'labile')%>%
select(-c(log10:asin, network, net_act, ecoNetConsensusScore, numberOfNodes))%>%
group_by(DayNight)%>%
nest()%>%
mutate(data = map(data, ~filter(.x, !is.na(xic))%>%
group_by(superclass_consensus, Organism, Replicate)%>%
summarize_if(is.numeric, sum, na.rm = TRUE)%>%
ungroup()
))%>%
unnest(data)%>%
spread(DayNight,xic)%>%
gather(DayNight,xic, Day:Night)
allLmerStats <- figSixstats %>%
bind_rows(growthLoadPVals, depletionStatsCombined) %>%
ungroup()
allLmerStats
View(allLmerStats)
## Superclass and TIC
groupedStatsLabile <- labileChange%>%
filter(Organism != 'CCA')%>%
mutate(group = ifelse(Organism %like% c('Poc%', 'Por%'), 'Coral', 'Fleshy algae'))%>%
group_by(group, Organism, Replicate, DayNight, superclass_consensus)%>%
summarize_if(is.numeric, sum, na.rm = TRUE)%>%
ungroup()%>%
# spread(DayNight, xic)%>%
# mutate(xic = Day-Night)%>%
#
mutate(xic = log10(xic + 1),
test = 'superclass')
labileChange
groupedStatsLabile
View(groupedStatsLabile)
figSixstats
View(figSixstats)
View(figSixstats%>% filter(FDR < 0.05))
xic_change_ttest
test <- feature_stats_wdf%>%
ungroup()%>%
left_join(networking%>%
select(feature_number, network), by = 'feature_number')%>%
mutate(net_act = case_when(network == -1 ~ -as.numeric(feature_number),
TRUE ~ network))%>%
left_join(all_activity, by = c('net_act', 'DayNight'))%>%
left_join(ecoNet%>%
rename(feature_number = scan)%>%
mutate(feature_number = as.character(feature_number)), by = c('feature_number', 'network'))%>%
filter(activity == 'labile',
Timepoint == 'T0')
test
test <- feature_stats_wdf%>%
ungroup()%>%
left_join(networking%>%
select(feature_number, network), by = 'feature_number')%>%
mutate(net_act = case_when(network == -1 ~ -as.numeric(feature_number),
TRUE ~ network))%>%
left_join(all_activity, by = c('net_act', 'DayNight'))%>%
left_join(ecoNet%>%
rename(feature_number = scan)%>%
mutate(feature_number = as.character(feature_number)), by = c('feature_number', 'network'))%>%
filter(activity == 'labile',
Timepoint == 'T0')%>%
separate(ecoNetConsensus, c('superclass_consensus', 'class_consensus', 'subclass_consensus'), remove = FALSE, sep = ';')%>%
select(Organism, Replicate, DayNight, superclass_consensus, xic)%>%
filter(Organism != 'CCA')%>%
mutate(group = ifelse(Organism %like% c('Poc%', 'Por%'), 'Coral', 'Fleshy algae'))
test
