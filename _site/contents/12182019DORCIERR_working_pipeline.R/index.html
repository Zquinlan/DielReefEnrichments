<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.22.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>12182019dorcierr_working_pipeline.r - DORCIERR</title>
<meta name="description" content="``` Script Written by Zach Quinlan 06/19/19 Re-organization of DORCIERR_FCM_fDOM.R because it needs to be cleaner 07/15/2019 Only working on daytime exudation and remineralization Rewritten with changes to RR3 starting pipeline 10/11/2019 16s rRNA amplicon seque3nce data added in a upaded 10/18/2019 Added in ClassyFire annotations from Inchi_keys 10/07/2019">


  <meta name="author" content="Zach Quinlan">
  
  <meta property="article:author" content="Zach Quinlan">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="DORCIERR">
<meta property="og:title" content="12182019dorcierr_working_pipeline.r">
<meta property="og:url" content="/%7B%7B%20site.baseurl%20%7D%7D/contents/12182019DORCIERR_working_pipeline.R/">


  <meta property="og:description" content="``` Script Written by Zach Quinlan 06/19/19 Re-organization of DORCIERR_FCM_fDOM.R because it needs to be cleaner 07/15/2019 Only working on daytime exudation and remineralization Rewritten with changes to RR3 starting pipeline 10/11/2019 16s rRNA amplicon seque3nce data added in a upaded 10/18/2019 Added in ClassyFire annotations from Inchi_keys 10/07/2019">







  <meta property="article:published_time" content="2021-05-05T16:19:39-07:00">





  

  


<link rel="canonical" href="/%7B%7B%20site.baseurl%20%7D%7D/contents/12182019DORCIERR_working_pipeline.R/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Zach Quinlan",
      "url": "/%7B%7B%20site.baseurl%20%7D%7D/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/%7B%7B%20site.baseurl%20%7D%7D/feed.xml" type="application/atom+xml" rel="alternate" title="DORCIERR Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/%7B%7B%20site.baseurl%20%7D%7D/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--posts wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/%7B%7B%20site.baseurl%20%7D%7D/"><img src="/%7B%7B%20site.baseurl%20%7D%7D/assets/images/logo.png" alt="DORCIERR"></a>
        
        <a class="site-title" href="/%7B%7B%20site.baseurl%20%7D%7D/">
          DORCIERR
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/%7B%7B%20site.baseurl%20%7D%7D/_pages/contents/">Repository Contents</a>
            </li><li class="masthead__menu-item">
              <a href="/%7B%7B%20site.baseurl%20%7D%7D/assets/images/album">Photos</a>
            </li><li class="masthead__menu-item">
              <a href="https://www.doi.org/">Paper</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Repository Contents</span>
        

        
        <ul>
          
            <li><a href="/%7B%7B%20site.baseurl%20%7D%7D/_pages/contents/canopus_model.R/">canopus_model.R</a></li>
          
            <li><a href="/%7B%7B%20site.baseurl%20%7D%7D/_pages/contents/bicluster.py/">bicluster.py</a></li>
          
            <li><a href="/%7B%7B%20site.baseurl%20%7D%7D/_pages/contents/Microbial_pipeline.R/">Microbial_pipeline.R</a></li>
          
            <li><a href="/%7B%7B%20site.baseurl%20%7D%7D/_pages/contents/metabolite_modeled_lability.R/">metabolite_modeled_lability.R</a></li>
          
            <li><a href="/%7B%7B%20site.baseurl%20%7D%7D/_pages/contents/12182019DORCIERR_working_pipeline.R/">12182019DORCIERR_working_pipeline.R</a></li>
          
            <li><a href="/%7B%7B%20site.baseurl%20%7D%7D/_pages/contents/metabolite_trends.R/">metabolite_trends.R</a></li>
          
            <li><a href="/%7B%7B%20site.baseurl%20%7D%7D/_pages/contents/current_dorcierr_working_pipeline.R/">current_dorcierr_working_pipeline.R</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <a href="/%7B%7B%20site.baseurl%20%7D%7D/assets/images/album"><span class="nav__sub-title">Photos</span></a>
        

        
      </li>
    
      <li>
        
          <a href="https://www.doi.org/"><span class="nav__sub-title">Paper</span></a>
        

        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <div class="archive">
    
      <h1 id="page-title" class="page__title">12182019dorcierr_working_pipeline.r</h1>
    
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Script Written by Zach Quinlan 06/19/19
# Re-organization of DORCIERR_FCM_fDOM.R because it needs to be cleaner 07/15/2019
# Only working on daytime exudation and remineralization
# Rewritten with changes to RR3 starting pipeline 10/11/2019
# 16s rRNA amplicon seque3nce data added in a upaded 10/18/2019
# Added in ClassyFire annotations from Inchi_keys 10/07/2019

## Do exudate feature finder but with offshore 
## Do Fold change differecnce to limit the initial features to only things which change between TF and T0
##    -Maybe...
## Add minimum value/2 to all XIC values


# LOADING -- packages -------------------------------------------------------
#Data mungering
library(tidyverse)
library(data.table)
library(DescTools)
library(broom)
library(readxl)
library(multcomp)
library(CHNOSZ)
library(furrr)
library(future)
library(biclustermd)
library(webchem)
library(classyfireR)
library(randomForest)

#PCoA, PERMANOVA
library(vegan)
library(ape)

#Visualizations
library(wesanderson)
library(RColorBrewer)
library(gplots)
library(gtable)

#Defining functions and removing issues with overlapping function calls
map &lt;- purrr::map
select &lt;- dplyr::select
tidy &lt;- broom::tidy
rename &lt;- dplyr::rename

zscore &lt;- function(x) {
  (x-mean(x, na.rm = TRUE))/sd(x, na.rm = TRUE)
}
# CORES -- setting processors available -----------------------------------
##Only used if future_mapping
# num_cores &lt;- availableCores() -1
# don't murder your compututer and save your self a core
# this is the parellel planning step (changes global env so this is plan for all parellel 
# work unless specificed otherwise)
# plan(multiprocess, workers = num_cores) #defaults to sequential process, multiprocess is one option for parellel

# LOADING -- dataframes  ------------------------------------------------------
## FCM and fDOM data
dorc_fcm_fdom &lt;- read_xlsx("~/Documents/GitHub/DORCIERR/data/raw/DOC_fDOM_FCM/DORCIERR_fDOM_FCM.xlsx")%&gt;%
  rename(sample_name =`Sample Name of DORCIERR_FCM_Final`)%&gt;%
  rename('DayNight' = 'Experiment')%&gt;%
  rename(Organism = 'Organsim')%&gt;%
  mutate(Organism = case_when(Organism == "Water" ~ "Water control",
                              TRUE ~ as.character(Organism)))

#DOC data
moorea_doc &lt;- read_xlsx("~/Documents/GitHub/DORCIERR/data/raw/DOC_fDOM_FCM/MO17_ExpSummary_DOC.2018.04.04.xlsx")%&gt;%
  dplyr::select(1:2)%&gt;%
  rename(sample_name = 1)%&gt;%
  rename(DOC = 2)

# True hits and analog hits are exported CSVs from GNPS
# True hits are more strictly matched to the library
true_hits &lt;- read_tsv("~/Documents/GitHub/DORCIERR/data/raw/metabolomics/Library-hits.tsv")%&gt;%
  rename("feature_number" = '#Scan#')

analog_hits &lt;- read_tsv("~/Documents/GitHub/DORCIERR/data/raw/metabolomics/Analog-hits.tsv")%&gt;%
  rename("feature_number" = '#Scan#')

# Node info includes networking information about each feature
node_info &lt;- read_tsv("~/Documents/GitHub/DORCIERR/data/raw/metabolomics/Node_info.tsv")%&gt;%
  rename('feature_number' = 'cluster index',
         'network' = 'componentindex')

# Canopus tries to classify each feature
canopus_anotations &lt;- read_csv("~/Documents/GitHub/DORCIERR/data/raw/metabolomics/Canopus_classes.csv")

chemont_anotations &lt;- read_csv("~/Documents/GitHub/DORCIERR/data/raw/metabolomics/categories.canopus.strings.nelsonMarch2019.CSV")%&gt;%
  rename('canopus_annotation' = 'name')

# Sirius and Zodiac both try to assign molecular formulas to all the features
sirius_zodiac_anotations &lt;- read_csv("~/Documents/GitHub/DORCIERR/data/raw/metabolomics/SIRIUS_Zodiac_converted.csv")%&gt;%
  rename(feature_number = 1)%&gt;%
  dplyr::select(-c(14:ncol(.)))


# Feature table has all features found within the experiments and blanks
# The columns need to be changed to the actual experiment sample codes
# Feature_table_raw is the raw export from MZMine
feature_table_raw &lt;- read_csv("~/Documents/GitHub/DORCIERR/data/raw/metabolomics/Morrea_Feayures-Table_all_Gap-Filled5.csv")%&gt;%
  rename('feature_number' = 'row ID')

ms_sample_codes &lt;- read_csv("~/Documents/GitHub/DORCIERR/data/raw/metabolomics/Mo'orea 2017 Mass spec sample codes - Sheet1.csv")%&gt;%
  rename('run_code' = 'Sample ID',
         'sample_code' = 'Sample Name')

# Networking information for analyzing stats
network_id &lt;- feature_metadata%&gt;%
  dplyr::select('feature_number', 'network', 'LibraryID', 'Compound_NameAnalog_', 'ZodiacMF', 'ZodiacScore',
                'canopus_annotation', 'level', 'canopus_probability', 'CLASS_STRING')
network_id$feature_number &lt;- as.character(network_id$feature_number)

# 16s rRNA sequences
microbe_abundance_raw &lt;- read_tsv("~/Documents/GitHub/DORCIERR/data/raw/microbes/MCR2017.16S.Nelson.Pipeline.October2019/abundance_table_100.shared.tsv")
microbe_taxonomy &lt;- read_tsv("~/Documents/GitHub/DORCIERR/data/raw/microbes/MCR2017.16S.Nelson.Pipeline.October2019/annotations_100.taxonomy.tsv")

# NAP
nap_df &lt;- read_tsv("~/Documents/GitHub/DORCIERR/data/raw/metabolomics/moorea2017_NAP.tsv")%&gt;%
  rename("feature_number" = "cluster.index")

# CLEANING -- SIRIUS_Zodiac elemental composition of molecular formulas -------------------------------------------
networking_elements &lt;- sirius_zodiac_anotations%&gt;%
  filter(!ZodiacMF == "not_explainable")%&gt;%
  group_by(feature_number)%&gt;% 
  do(., rownames_to_column(as.data.frame(makeup(.$ZodiacMF, multiplier = 1), var = "element")))%&gt;%
  spread(rowname, 3)

networking_elements[is.na(networking_elements)] &lt;- 0

#Filter NOSC and Zodiac
networking_energy &lt;- networking_elements%&gt;%
  dplyr::select(c(1, 'C', 'H', 'N', 'O', 'P', 'S'))%&gt;%
  add_column(NOSC = (-((4*.$C + .$H - 3*.$N - 2*.$O + 5*.$P - 2*.$S)/.$C)+4))%&gt;%
  add_column(dG = 60.3-28.5*.$NOSC)%&gt;%
  filter(NOSC &lt; 4 &amp; NOSC &gt; -4)%&gt;%
  filter(P &lt; 2)

# CLEANING -- Canopus---------------------------

canopus_annotation_names &lt;- canopus_anotations%&gt;%
  gather(canopus_annotation, canopus_probability, 2:ncol(.))

canopus_chemonnt_tidy &lt;- left_join(canopus_annotation_names, chemont_anotations, by = "canopus_annotation")

# SET -- CANOPUS filters --------------------------------------------------
# Canopus annotations which are above level 3 AND 80% probability

canopus_filtered_tidy &lt;- canopus_chemonnt_tidy%&gt;%
  rename('feature_number' = 'name')%&gt;%
  group_by(feature_number)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~filter(.x, canopus_probability &gt;= 0.80)%&gt;%
                      filter(level &gt; 3)%&gt;%
                      # filter(., level == max(level))%&gt;%
                      filter(canopus_probability == max(canopus_probability))%&gt;%
                      filter(level == max(level))%&gt;%
                      filter(nchar(CLASS_STRING) == max(nchar(CLASS_STRING)))%&gt;%
                      filter(nchar(canopus_annotation) == max(nchar(canopus_annotation)))))%&gt;%
  unnest(data)

write_csv(canopus_filtered_tidy, "~/Documents/GitHub/DORCIERR/data/analysis/canopus_filtered_tidy.csv")

# Combines canopus, sirus, and zodiac
super_computer_annotations &lt;- full_join(full_join(canopus_filtered_tidy, 
                                                  sirius_zodiac_anotations, by = "feature_number"),
                                        networking_energy, by = "feature_number")%&gt;%
  add_column(`characterization scores` = .$`quality`)%&gt;%
  mutate(`characterization scores` = case_when(`characterization scores` != "Good" ~ "Bad quality",
                                               ZodiacScore &lt; .98 ~ "Low probability",
                                               TRUE ~ as.character(`characterization scores`)))



# CLEANING -- METADATA and filter out bad samples --------------------------
## join library hits, analog hits and super computer predictions
metadata &lt;- full_join(node_info, 
                      full_join(super_computer_annotations,
                                full_join(feature_table_raw[1:4],
                                          full_join(true_hits, analog_hits, by = "feature_number",
                                                    suffix = c("Library_", "Analog_")),
                                          by = "feature_number"),
                                by = "feature_number"),
                      by = "feature_number")%&gt;%
  left_join(nap_df, by = "feature_number", suffix = c("", "_nap"))%&gt;%
  add_column(binary_ID = .$LibraryID, .before = 1)%&gt;%
  mutate(binary_ID = case_when(binary_ID != "N/A" ~ "1",
                               Compound_NameAnalog_ != "NA" ~ "2",
                               !is.na(ConsensusSC) ~ "3",
                               TRUE ~ as.character(binary_ID)))%&gt;%
  add_column(combined_ID = .$LibraryID, .before = 1)%&gt;%
  mutate(combined_ID = case_when(binary_ID == "1" ~ LibraryID,
                                 binary_ID == "3" ~ ConsensusSC,
                                 binary_ID == "2" ~ Compound_NameAnalog_,
                                 binary_ID == "N/A" ~ canopus_annotation,
                                 TRUE ~ as.character(binary_ID)))%&gt;%
  mutate(inchi_binary = case_when(!is.na(INCHILibrary_) ~ "1",
                                  !is.na(INCHIAnalog_) &amp; is.na(INCHILibrary_) | 
                                    !is.na(INCHIAnalog_) &amp; INCHILibrary_ == "N/A" ~ "2",
                                  TRUE ~ "3"))%&gt;%
  mutate(inchi_combined = case_when(inchi_binary == "1" ~ INCHILibrary_,
                                    inchi_binary == "2" ~ INCHIAnalog_,
                                    TRUE ~ "N/A"))


metadata$feature_number &lt;- as.character(metadata$feature_number)

networking &lt;- metadata%&gt;%
  dplyr::select(c(feature_number, network,combined_ID, binary_ID, 
                  canopus_annotation:CLASS_STRING, `characterization scores`, C:dG, inchi_binary, inchi_combined))%&gt;%
  separate(CLASS_STRING, c("level 1", "level 2", "level 3",
                           "level 4", "level 5", "level 6", "level 7", "level 8"), sep = ";")%&gt;%
  mutate(c_temp = case_when(C &gt; 0 ~ "C",
                            TRUE ~ "_"),
         o_temp = case_when(O &gt; 0 ~ "O",
                            TRUE ~ "_"),
         h_temp = case_when(H &gt; 0 ~ "H",
                            TRUE~ "_"),
         n_temp = case_when(N &gt; 0 ~ "N",
                            TRUE ~ "_"),
         p_temp = case_when(P &gt; 0 ~ "P",
                            TRUE ~ "_"),
         s_temp = case_when(S &gt; 0 ~ "S",
                            TRUE ~ "_"))%&gt;%
  unite(simplified_makeup, c("c_temp", "h_temp", "o_temp", "n_temp", "p_temp", "s_temp"), sep = "")%&gt;%
  mutate(simplified_makeup = gsub("_","", simplified_makeup),
         simplified_makeup = case_when(`characterization scores` != "Good" ~ "uncharacterized",
                                       simplified_makeup == "" ~ "uncharacterized",
                                       TRUE ~ as.character(simplified_makeup)))
         

## making feature table so we can remove blanks
# have to change the MS codes for sample codes
# dplyr::selecting for RR3 
feature_table_temp &lt;- feature_table_raw%&gt;%
  dplyr::select(-X326)%&gt;%
  dplyr::select(-c(2:4))%&gt;%
  gather(run_code, ion_charge, 2:ncol(.))%&gt;%
  spread(feature_number, ion_charge)

feature_table_temp$run_code &lt;- feature_table_temp$run_code%&gt;%
  gsub(".mzXML Peak area", "", .)%&gt;%
  gsub("_MSMS", "", .)

feature_table_dirty &lt;- left_join(ms_sample_codes, feature_table_temp, by = "run_code")%&gt;%
  dplyr::select(-run_code)%&gt;%
  filter(sample_code %like any% c("%Blank%","R_%", "D_%", "M_%", "SPIFFy_%"))%&gt;%
  filter(!sample_code %like any% c("%C18%", "%XAD%"))%&gt;%
  gather(feature_number, ion_charge, 2:ncol(.))%&gt;%
  spread(sample_code, ion_charge)

# DEFINING -- Samples and blanks ------------------------------------------
## defining what columns the samples are in
ions_samples &lt;- 10:259

## defining different blanks
ions_blanks &lt;- c(2:8, 260)


# FLAGGING -- BACKGROUND FEATURES flagging and removing ------------------------------------------------
# Background features are defined as features where max(blanks) &gt;= 0.5*mean(samples)
ions &lt;- feature_table_dirty

ions$max_blanks &lt;- apply(ions[ions_blanks], 1, max)

ions$mean_samples &lt;- apply(ions[ions_samples], 1, mean)


# This section finds the features where mean area under the curve across all samples is larger than 2 * max of the blanks
# The non background features are saved into a vector so that they can be filtered from the master database
# mean(samples)*0.5 &gt; max_blanks
no_background &lt;-ions%&gt;%
  mutate(mean_samples = case_when(mean_samples*0.5 &gt; max_blanks ~ "real",
                                  TRUE ~ "background"))%&gt;%
  rename("background" = "mean_samples")

# FLAGGING -- TRANSIENT FEATURES flagging and removing ---------------------------------------------
# Transient features are defined as features who's area under the curve is not more than 2E5 in at least 3 samples
# This was determined by comparing gap filled and non-gap filled data and selecting for the lowest peak area in non-gap filled data
# This gives the assumption that anything lower than 2E5 is noise. See supplemental figure
feature_table_no_background_trans_finder &lt;- feature_table_dirty%&gt;%
  gather(sample, xic, 2:ncol(.))%&gt;%
  separate(sample, "experiment", sep = "_", remove = FALSE, extra = "drop")%&gt;%
  filter(!experiment %like% "%Blank%")%&gt;%
  filter(!sample %like% "%Blank%")%&gt;%
  mutate(experiment = case_when(experiment == "D" ~ "Dorcierr_transient",
                                experiment == "M" ~ "Mordor_transient",
                                experiment == "R" ~ "RR3_transient",
                                TRUE ~ "SPIFFy_transient"))%&gt;%
  group_by(experiment)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~ spread(.x, sample, xic)%&gt;%
                      add_column(trans_feature_finder = rowSums(.[3:ncol(.)] &gt; 2E5), .before = 2)%&gt;%
                      mutate(transient = case_when(trans_feature_finder &gt;= 3 ~ "real",
                                                   TRUE ~ "transient"))%&gt;%
                      dplyr::select(c(feature_number, transient))))%&gt;%
  unnest(data)%&gt;%
  spread(experiment, transient)


feature_table_no_back_trans_filter &lt;- full_join(feature_table_no_background_trans_finder, no_background, by = "feature_number")%&gt;%
  dplyr::select(feature_number, background, everything())

# FILTERING -- out background and transient features ----------------------
dorcierr_real_features &lt;- as.vector(feature_table_no_back_trans_filter%&gt;%
                                      filter(background == "real")%&gt;%
                                      filter(Dorcierr_transient == "real"))$feature_number

feature_table_no_back_trans &lt;- feature_table_dirty%&gt;%
  gather(sample, val, 2:ncol(.))%&gt;%
  spread(feature_number, val)%&gt;%
  filter(sample %like any% c("D_%", "%Blank%", "%OF%"))%&gt;%
  dplyr::select(c(1, dorcierr_real_features))%&gt;%
  gather(feature_number, val, 2:ncol(.))%&gt;%
  spread(sample, val)


# FILTERING -- LOG2 bottleneck --------------------------------------------
## Everything has to double from T0 to TF (1 &gt; log2(TF/T0) &lt; 1)
log2_features &lt;- (feature_table_no_back_trans%&gt;%
  gather(sample_name, xic, 2:ncol(.))%&gt;%
  ungroup()%&gt;%
  separate(sample_name, c("Experiment", "Organism", "Replicate", "Timepoint"), sep = "_")%&gt;%
  filter(!Experiment %like% "%Blank%",
         !Organism %like% "%Blank")%&gt;%
  mutate(Experiment = case_when(Experiment == "D" ~ "dorcierr",
                                       Experiment == "M" ~ "mordor",
                                       Experiment == "R" ~ "RR3",
                                       TRUE ~ as.character(Experiment)),
         Organism = case_when(Organism == "CC" ~ "CCA",
                                     Organism == "DT" ~ "Dictyota",
                                     Organism == "PL" ~ "Porites lobata",
                                     Organism == "PV" ~ "Pocillopora verrucosa",
                                     Organism == "TR" ~ "Turf",
                                     Organism == "WA" ~ "Water control",
                                     TRUE ~ as.character(Organism)))%&gt;%
  separate(Timepoint, c("Timepoint", "DayNight"), sep = 2)%&gt;%
  mutate(DayNight = case_when(DayNight == "D" ~ "Day",
                              TRUE ~ "Night"),
         xic = case_when(xic == 0 ~ 1,
                         TRUE ~ as.numeric(xic)))%&gt;%
  spread(Timepoint, xic)%&gt;%
  group_by(Organism, DayNight, feature_number)%&gt;%
  summarize_if(is.numeric, mean, na.rm = TRUE)%&gt;%
  mutate(log2 = log2(TF/T0))%&gt;%
  filter(log2 &gt;= 1 | log2 &lt;= -1)%&gt;%
  ungroup())$feature_number%&gt;%
  unique()%&gt;%
  as.vector()

# RELATIVIZATION AND NORMALIZATION -- RA_asin -&gt; Not grouped by ambient or exudate -----------------
feature_table_relnorm &lt;- feature_table_no_back_trans%&gt;%
  filter(feature_number %in% log2_features)%&gt;%
  gather(sample_name, xic, 2:ncol(.))%&gt;%
  ungroup()%&gt;%
  mutate(xic = case_when(xic == 0 ~ 1,
                         TRUE ~ as.numeric(xic)))%&gt;%
  group_by(sample_name)%&gt;%
  mutate(TIC = sum(xic),
         RA = xic/TIC,
         asin = asin(sqrt(RA)))%&gt;%
  dplyr::select(-TIC)%&gt;%
  gather(transformation, values, xic:asin)%&gt;%
  arrange(transformation)%&gt;%
  unite(sample_transformed, c("sample_name", "transformation"), sep = "_")%&gt;%
  spread(sample_transformed, values)


# DORCIERR feature_table --------------------------------------------------
feature_table_combined &lt;- right_join(metadata, feature_table_relnorm, by = "feature_number")

dorcierr_table_wdf_temp &lt;- feature_table_combined%&gt;%
  dplyr::select(c(feature_number, everything()))

# NORMALIZATION -- NOSC and energy to C -----------------------------------
# Percent is Reltaive Abundance * C content of feature Final equation is (RA*C) / (sum(RA*C)) * NOSC
carbon_normalized_ra_NOSC &lt;- dorcierr_table_wdf_temp%&gt;%
  filter(`characterization scores` == "Good")%&gt;%
  dplyr::select(c(feature_number, C, ends_with("_RA")))%&gt;%
  gather(sample_name, ra, 3:ncol(.))%&gt;%
  mutate(percent_total_C = ra*C)%&gt;%
  group_by(sample_name)%&gt;%
  mutate(sum_c = sum(percent_total_C))%&gt;%
  mutate(carbon_norm_temp = percent_total_C/sum_c)%&gt;%
  ungroup()%&gt;%
  right_join(metadata%&gt;%
               dplyr::select(c(feature_number, NOSC)),
             .,  by = "feature_number")%&gt;%
  mutate(carbon_normalized_NOSC = carbon_norm_temp*NOSC)%&gt;%
  dplyr::select(c(feature_number, sample_name, carbon_normalized_NOSC))%&gt;%
  mutate(sample_name = gsub("_RA", "_RAC", sample_name))%&gt;%
  spread(sample_name, carbon_normalized_NOSC)

# Percent is XIC * C content of feature 
carbon_normalized_xic_NOSC &lt;- dorcierr_table_wdf_temp%&gt;%
  filter(`characterization scores` == "Good")%&gt;%
  dplyr::select(c(feature_number, C, ends_with("_xic")))%&gt;%
  gather(sample_name, xic, 3:ncol(.))%&gt;%
  mutate(percent_total_C = xic*C)%&gt;%
  group_by(sample_name)%&gt;%
  mutate(sum_c = sum(percent_total_C))%&gt;%
  mutate(carbon_norm_temp = percent_total_C/sum_c)%&gt;%
  ungroup()%&gt;%
  right_join(metadata%&gt;%
               dplyr::select(c(feature_number, NOSC)),
             .,  by = "feature_number")%&gt;%
  mutate(carbon_normalized_NOSC = carbon_norm_temp*NOSC)%&gt;%
  dplyr::select(c(feature_number, sample_name, carbon_normalized_NOSC))%&gt;%
  mutate(sample_name = gsub("_xic", "_xicc", sample_name))%&gt;%
  spread(sample_name, carbon_normalized_NOSC)

carbon_normalized_NOSC &lt;- full_join(carbon_normalized_ra_NOSC, carbon_normalized_xic_NOSC, by = "feature_number")

# CLEANING-- adding carbon normalized values to wdf ------------------
dorcierr_features_wdf &lt;- left_join(dorcierr_table_wdf_temp, carbon_normalized_NOSC, by = 'feature_number')

write_csv(dorcierr_features_wdf, "~/Documents/GitHub/DORCIERR/data/analysis/Dorcierr_feature_table_master_post_filtered.csv")

# PRE-CLEANING -- Making Dorcierr working data frame for stats -----------------------------
dorc_transposed &lt;- dorcierr_features_wdf%&gt;%
  dplyr::select(c(feature_number, ends_with("_asin")))%&gt;%
  gather(sample_ID, angular, 2:ncol(.))%&gt;%
  spread(feature_number, angular)

dorc_transposed$sample_ID &lt;- dorc_transposed$sample_ID%&gt;%
  gsub("_asin", "", .)%&gt;%
  gsub("-", "_", .)

blanks_wdf &lt;- dorc_transposed%&gt;%
  filter(sample_ID %like% "%Blank%",
         !sample_ID == 'D_Blank_DI')%&gt;%
  mutate(sample_ID = case_when(sample_ID == "Blank_Lot_6350565_01"~ "Blank_Blank_635056501",
                               sample_ID == "Blank_SD_01_A" ~ "Blank_Blank_SD01A",
                               sample_ID == "Blank_SD_01_B" ~ "Blank_Blank_SD01B",
                               sample_ID == "Blank_SD_LoRDI" ~ "Blank_Blank_SDLoRDI",
                               sample_ID == "Blank_SD_PPL" ~ "Blank_Blank_SDPPL",
                               sample_ID == "Blank? look up name on PPL" ~ "Blank_Blank_unknown",
                               sample_ID == "D_Blank" ~ "Blank_Blank_D",
                               TRUE ~ "Blank_Blank_Spiffy"))%&gt;%
  separate(sample_ID, c("Experiment", "Organism", "Replicate", "Timepoint"), sep = "_")

dorc_wdf &lt;- dorc_transposed%&gt;%
  separate(sample_ID, c("Experiment", "Organism", "Replicate", "Timepoint"), sep = "_")%&gt;%
  filter(!Experiment %like% "%Blank%",
         !Organism %like% "%Blank")%&gt;%
  dplyr::mutate(Experiment = case_when(Experiment == "D" ~ "dorcierr",
                                       Experiment == "M" ~ "mordor",
                                       Experiment == "R" ~ "RR3",
                                       TRUE ~ as.character(Experiment)))%&gt;%
  dplyr::mutate(Organism = case_when(Organism == "CC" ~ "CCA",
                                     Organism == "DT" ~ "Dictyota",
                                     Organism == "PL" ~ "Porites lobata",
                                     Organism == "PV" ~ "Pocillopora verrucosa",
                                     Organism == "TR" ~ "Turf",
                                     Organism == "WA" ~ "Water control",
                                     TRUE ~ as.character(Organism)))%&gt;%
  separate(Timepoint, c("Timepoint", "DayNight"), sep = 2)%&gt;%
  mutate(DayNight = case_when(DayNight == "D" ~ "Day",
                              TRUE ~ "Night"))
# CLEANING -- Subsetting to FCM or fDOM -----------------------------------------------
fdom_wdf &lt;- dorc_fcm_fdom%&gt;%
  dplyr::select(c(4:'PARAFAC6'))%&gt;%
  filter(!Timepoint == "T1",
         !Timepoint == "T2",
         !Timepoint == "T3",
         !Timepoint == "T4",
         !Timepoint == "T5",
         !Timepoint == "T6")

fdom_wdf$Replicate &lt;- as.character(fdom_wdf$Replicate)

fcm_wdf &lt;- dorc_fcm_fdom%&gt;%
  dplyr::select(c(1:8,34:ncol(.)))

# CLEANING -- xic data ----------------------------------------
## Need to find difference between T0 and TF for each organism
feature_xic &lt;- dorcierr_features_wdf%&gt;%
  dplyr::select(c(feature_number, ends_with("_xic")))%&gt;%
  gather(sample_ID, xic, 2:ncol(.))%&gt;%
  mutate(sample_ID = gsub("_xic", "", sample_ID))%&gt;%
  mutate(sample_ID = gsub("-", "_", sample_ID))%&gt;%
  separate(sample_ID, c("Experiment", "Organism", "Replicate", "Timepoint"), sep = "_")%&gt;%
  filter(!Experiment %like% "%Blank%",
         !Organism %like% "%Blank",
         !Timepoint == "T0")%&gt;%
  dplyr::mutate(Experiment = case_when(Experiment == "D" ~ "dorcierr",
                                       Experiment == "M" ~ "mordor",
                                       Experiment == "R" ~ "RR3",
                                       TRUE ~ as.character(Experiment)))%&gt;%
  dplyr::mutate(Organism = case_when(Organism == "CC" ~ "CCA",
                                     Organism == "DT" ~ "Dictyota",
                                     Organism == "PL" ~ "Porites lobata",
                                     Organism == "PV" ~ "Pocillopora verrucosa",
                                     Organism == "TR" ~ "Turf",
                                     Organism == "WA" ~ "Water control",
                                     TRUE ~ as.character(Organism)))%&gt;%
  separate(Timepoint, c("Timepoint", "DayNight"), sep = 2)%&gt;%
  mutate(DayNight = case_when(DayNight == "D" ~ "Day",
                              TRUE ~ "Night"))

dorc_time &lt;- feature_xic%&gt;%
  group_by(DayNight)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~
                      dplyr::select(.x, -Replicate)%&gt;%
                      group_by(Organism, feature_number, Timepoint)%&gt;%
                      summarize_if(is.numeric, mean)%&gt;%
                      ungroup()%&gt;%
                      spread(Timepoint, xic)%&gt;%
                      add_column(difference = .$TF-.$T0)%&gt;%
                      dplyr::select(-c("TF", "T0"))),
         increase_over_time = map(data, ~
                                    filter(.x, difference &gt; 0)%&gt;%
                                    unite(combined, c(Organism, feature_number), sep = "_", remove = TRUE)),
         decrease_over_time = map(data, ~
                                    filter(.x, difference &lt; 0)%&gt;%
                                    unite(combined, c(Organism, feature_number), sep = "_", remove = TRUE)))

decrease_over_time &lt;- dorc_time%&gt;%
  dplyr::select(c(1, decrease_over_time))%&gt;%
  unnest(decrease_over_time)%&gt;%
  unite(combined, c(combined, DayNight), sep = "_")

increase_over_time &lt;- dorc_time%&gt;%
  dplyr::select(c(1, increase_over_time))%&gt;%
  unnest(increase_over_time)%&gt;%
  unite(combined, c(combined, DayNight), sep = "_")

##Finding Exudates and accumulites
organism_exudates &lt;- feature_xic%&gt;%
  group_by(DayNight, Timepoint)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~
                      dplyr::select(.x, -c(Replicate))%&gt;%
                      group_by(Organism, feature_number)%&gt;%
                      summarize_if(is.numeric, mean)%&gt;%
                      ungroup()%&gt;%
                      spread(Organism, xic)%&gt;%
                      gather(Organism, xic, 2:6)%&gt;%
                      mutate(difference_from_water = xic - `Water control`)%&gt;%
                      as.data.frame()%&gt;%
                      dplyr::select(-`Water control`)%&gt;%
                      unite(combined, c(Organism, feature_number), sep = "_", remove = TRUE)))%&gt;%
  unnest(data)%&gt;%
  unite(combined, c(combined, DayNight), sep = "_")

exudate &lt;-organism_exudates%&gt;%
  filter(Timepoint == "T0",
         difference_from_water &gt; 0.00)

accumulites &lt;-organism_exudates%&gt;%
  filter(Timepoint == "TF",
         difference_from_water &gt; 0.00)

# CLEANING -- feature ra data for graphing --------------------------------
feature_ra &lt;- dorcierr_features_wdf%&gt;%
  dplyr::select(c(feature_number, ends_with("_RA")))%&gt;%
  gather(sample_ID, ra, 2:ncol(.))%&gt;%
  mutate(sample_ID = gsub("_RA", "", sample_ID))%&gt;%
  mutate(sample_ID = gsub("-", "_", sample_ID))%&gt;%
  separate(sample_ID, c("Experiment", "Organism", "Replicate", "Timepoint"), sep = "_")%&gt;%
  filter(!Experiment %like% "%Blank%",
         !Organism %like% "%Blank",
         !Timepoint == "T0")%&gt;%
  dplyr::mutate(Experiment = case_when(Experiment == "D" ~ "dorcierr",
                                       Experiment == "M" ~ "mordor",
                                       Experiment == "R" ~ "RR3",
                                       TRUE ~ as.character(Experiment)))%&gt;%
  dplyr::mutate(Organism = case_when(Organism == "CC" ~ "CCA",
                                     Organism == "DT" ~ "Dictyota",
                                     Organism == "PL" ~ "Porites lobata",
                                     Organism == "PV" ~ "Pocillopora verrucosa",
                                     Organism == "TR" ~ "Turf",
                                     Organism == "WA" ~ "Water control",
                                     TRUE ~ as.character(Organism)))%&gt;%
  separate(Timepoint, c("Timepoint", "DayNight"), sep = 2)%&gt;%
  mutate(DayNight = case_when(DayNight == "D" ~ "Day",
                              TRUE ~ "Night"))

# PRE-STATS CLEAINING -- FCM Stats prep---------------------------------------------------------------------
## This should calculate mean cells per hour per µL for each organism
## Just looks at log10(TF) - mean(log10(T0))
## Will result in log10(cells*µL-1)*hr^-1

fcm_th_t0_prep &lt;-fcm_wdf%&gt;%
  filter(Timepoint %like any% c('T0', 'T4'),
         !Organism == 'Influent',
         !Organism == 'Offshore')%&gt;%
  mutate(log_10_cellsµL = log10(`Cells µL-1`))%&gt;%
  dplyr::select(c(5:8, 15))%&gt;%
  spread(Timepoint, log_10_cellsµL)

fcm_t0 &lt;- fcm_th_t0_prep%&gt;%
  dplyr::select(-c(T4, Replicate))%&gt;%
  group_by(Organism, DayNight)%&gt;%
  summarize_if(is.numeric, mean, na.rm = TRUE)

fcm_rate_th_t0 &lt;- fcm_th_t0_prep%&gt;%
  dplyr::select(-T0)%&gt;%
  left_join(., fcm_t0, by = c("Organism", "DayNight"))%&gt;%
  add_column(change_per_hour = (.$T4 - .$T0)/24)

fcm_t7 &lt;- fcm_wdf%&gt;%
  mutate(log_10_cellsµL = log10(`Cells µL-1`))%&gt;%
  dplyr::select(c(5:8, 15))%&gt;%
  filter(Timepoint == c('TF'),
         !Organism == 'Influent')%&gt;%
  spread(Timepoint, log_10_cellsµL)

## This is the actual dataframe to use for running FCM stats
fcm_stats_df &lt;- left_join(fcm_t7, fcm_rate_th_t0, by = c("Organism", "Replicate", "DayNight"))%&gt;%
  dplyr::select(-c(5,6))%&gt;%
  gather(test, log_value, 4:5)

# PRE-STATS CLEANING -- fDOM and DOC --------------------------------------------------------------
fdom_log10 &lt;-fdom_wdf%&gt;%
  dplyr::select(c(1:5, 15:21))%&gt;%
  gather(fluor, val, 6:ncol(.))%&gt;%
  mutate(val = log10(val))%&gt;%
  spread(fluor, val)


doc_log10 &lt;- moorea_doc%&gt;%
  mutate_if(is.numeric, log10)%&gt;%
  filter(sample_name != "D_OF_1_T0N",
         sample_name != "D_IN_2_T0N",
         sample_name != "D_PL_3_TFN",
         sample_name != "D_TR_1_T0N",
         sample_name != "D_WA_2_T0D",
         sample_name != "D_WA_1_T0D",
         sample_name != "D_CC_1_T0D",
         sample_name != "D_CC_2_T0D")

fdom_doc_log10 &lt;- left_join(fdom_log10, doc_log10, by = "sample_name")%&gt;%
  dplyr::select(-sample_name)

# PRE-STATS CLEANING -- Metabolomics, combining with fDOM DOC ------------------------------------
dom_stats_wdf&lt;- dorc_wdf%&gt;%
  full_join(., fdom_doc_log10, by = c("Organism", "Timepoint", "Replicate", "DayNight"))%&gt;%
  filter(!Organism == "Influent",
         !Organism == "Offshore")%&gt;%
  gather(feature_number, asin, 6:ncol(.))

# PRE-STATS CLEANING -- Microbes and pre-filtering OTUs for abundance-----------------------------------------------
microbe_combined &lt;- microbe_abundance_raw%&gt;%
  dplyr::select(-1)%&gt;%
  mutate(Group = case_when(Group == "Dorcierr_D_DT_1_TFD" ~ "D_DT_1_TFD",
                           Group == "DORCIERR_D_WA_2_TFN" ~ "D_WA_2_TFN",
                           Group == "D_PV_2_TFN_SA504_SC704" ~ "D_PV_2_TFN",
                           Group == "D_PV_2_TFN_SA503_SC704" ~ "D_PV_3_TFN",
                           Group == "D_WA_4_TFN_SA503_SC703" ~ "D_PL_3_TFN",
                           Group == "D_WA_4_TFN_SA504_SC703" ~ "D_WA_4_TFN",
                           TRUE ~ as.character(Group)))%&gt;%
  filter(Group %like% "%D_%")%&gt;%
  rename(sample_code = Group)%&gt;%
  gather(OTU, reads, 3:ncol(.))%&gt;%
  # left_join(., microbe_taxonomy, by = "OTU")%&gt;%
  # dplyr::select(-Size)%&gt;%
  # separate(Taxonomy, c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "OTU_id"), sep = ";", remove = FALSE)%&gt;%
  separate(sample_code, c("Experiment", "Organism", "Replicate", "Timepoint"), sep = "_", remove = FALSE)%&gt;%
  dplyr::mutate(Experiment = case_when(Experiment == "D" ~ "dorcierr",
                                       Experiment == "M" ~ "mordor",
                                       Experiment == "R" ~ "RR3",
                                       TRUE ~ as.character(Experiment)))%&gt;%
  dplyr::mutate(Organism = case_when(Organism == "CC" ~ "CCA",
                                     Organism == "DT" ~ "Dictyota",
                                     Organism == "PL" ~ "Porites lobata",
                                     Organism == "PV" ~ "Pocillopora verrucosa",
                                     Organism == "TR" ~ "Turf",
                                     Organism == "WA" ~ "Water control",
                                     Organism == "IN" ~ "Influent",
                                     Organism == "OF" ~ "Offshore",
                                     TRUE ~ as.character(Organism)))%&gt;%
  separate(Timepoint, c("Timepoint", "DayNight"), sep = 2)%&gt;%
  mutate(DayNight = case_when(DayNight == "D" ~ "Day",
                              TRUE ~ "Night"))%&gt;%
  filter(Organism != "Offshore",
         Organism != "Influent")%&gt;%
  group_by(sample_code)%&gt;%
  mutate(sum = sum(reads),
         ra = reads/sum,
         asin = asin(sqrt(ra)))%&gt;%
  ungroup()%&gt;%
  group_by(OTU)%&gt;%
  mutate(abundant = case_when(max(ra) &gt; 0.01 | sum(ra &gt; 0.001) &gt;=3 ~ "abundant",
                              TRUE ~ "rare"))
  

microbe_no_rare &lt;- microbe_combined%&gt;%
  filter(abundant == "abundant")%&gt;%
  select(-abundant)


# SUMMARY -- Microbe filtering --------------------------------------------
microbe_summary &lt;- microbe_combined%&gt;%
  select(-c(Experiment, Organism, Replicate, Timepoint, DayNight, reads, asin, numOtus, sum))%&gt;%
  spread(sample_code, ra)


# PRE-STATS CLEANING -- microbe RA data  --------------------------------------------
ra_bigger_TF &lt;- microbe_no_rare%&gt;%
  dplyr::select(-c(reads, sum, asin, numOtus, sample_code))%&gt;%
  spread(Organism, ra)%&gt;%
  gather(Organism, ra, 6:10)%&gt;%
  mutate(difference = ra - `Water control`)%&gt;%
  filter(difference &gt; 0)%&gt;%
  dplyr::select(c(DayNight, OTU, Organism))


# SET SEED ----------------------------------------------------------------
set.seed(2005)

# STATS ANOVA -- DOM TWO-WAY -------------------------------------------------
# This line makes the names of the rows which will be added into the pvalue table
twoway_anova_rows &lt;- c("Organism", "Timepoint", "Organism*Timepoint")

# The actual Model and collection of f_values
aov_dom &lt;- dom_stats_wdf%&gt;%
  group_by(DayNight, feature_number)%&gt;%
  mutate(sum = sum(asin))%&gt;%
  filter(!sum == 0)%&gt;%
  dplyr::select(-sum)%&gt;%
  ungroup()%&gt;%
  group_by(DayNight, feature_number)%&gt;%
  nest()%&gt;%
  mutate(anova = map(data, ~ aov(asin ~ Organism*Timepoint, .x)%&gt;%
                       tidy()%&gt;%
                       filter(!term == "Residuals")%&gt;%
                       dplyr::select(term, p.value)))%&gt;%
  dplyr::select(-data)%&gt;%
  unnest(anova)%&gt;%
  ungroup()%&gt;%   
  add_column(FDR = p.adjust(.$p.value, method = "BH"))%&gt;%
  filter(FDR &lt; 0.05)

# Save siginificant values from test to a vector to filter out for post-hoc tests
# For timepoint we care about the features which differ both between organisms and which all primary producers create or eat
significant_organism_dom &lt;- (aov_dom%&gt;% 
                               filter(term == "Organism"))$feature_number%&gt;%
  unique()

significant_Timepoint_dom &lt;- (aov_dom%&gt;% 
                                filter(!term == "Organism"))$feature_number%&gt;%
  unique()

# STATS ANOVA -- FCM ONE-WAY -------------------------------------------------------
aov_fcm &lt;-fcm_stats_df%&gt;%
  group_by(test, DayNight)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~aov(log_value ~ Organism, .x)%&gt;%
                       tidy()%&gt;%
                       filter(term == "Organism")))%&gt;%
  unnest(data)

# STATS ANOVA -- Microbe TWO-Way ------------------------------------------
aov_microbe &lt;- microbe_no_rare%&gt;%
  filter(Timepoint == "TF")%&gt;%
  group_by(OTU)%&gt;%
  nest()%&gt;%
  mutate(anova = map(data, ~ aov(asin ~ Organism*DayNight, .x)%&gt;%
                       tidy()%&gt;%
                       filter(!term == "Residuals")%&gt;%
                       dplyr::select(term, p.value)))%&gt;%
  dplyr::select(-data)%&gt;%
  unnest(anova)

anova_microbe_pvalues &lt;- aov_microbe%&gt;%
  ungroup()%&gt;%  
  filter(p.value &lt; 0.05)
  # add_column(FDR = p.adjust(.$p.value, method = "BH"))%&gt;%
  # filter(FDR &lt; 0.05)

organism_significant_microbes &lt;- as.vector(anova_microbe_pvalues%&gt;%
                                             filter(term == "Organism"))$OTU

DayNight_significant_microbes &lt;- as.vector(anova_microbe_pvalues%&gt;%
                                             filter(term != "Organism"))$OTU

# PRE-POST-HOC CLEANING -- Organism dunnetts ------------------------------------------------------
## Making Post-Hoc dataframes filtering for significant p_values from Two-Way Anova
dom_organism_post_hoc &lt;- dom_stats_wdf%&gt;%
  filter(feature_number %in% significant_organism_dom)

# PRE-POST-HOC CLEANING -- Timepoint anova --------------------------------------------------
dom_timepoint_post_hoc &lt;- dom_stats_wdf%&gt;%
  filter(feature_number %in% significant_Timepoint_dom)

dom_timepoint &lt;- dom_timepoint_post_hoc%&gt;%
  group_by(Organism, DayNight, feature_number)%&gt;%
  mutate(sum = sum(asin))%&gt;%
  filter(!sum == 0)%&gt;%
  dplyr::select(-sum)%&gt;%
  ungroup()



# PRE-POST-HOC CLEANING -- Microbe Dunnetts and DayNight anova -------------------------------
mic_organism_post_hoc &lt;- microbe_no_rare%&gt;%
  filter(OTU %in% organism_significant_microbes)%&gt;%
  filter(Timepoint == "TF")

daynight_microbe_post_hoc &lt;- microbe_no_rare%&gt;%
  filter(OTU %in% DayNight_significant_microbes)%&gt;%
  filter(Timepoint == "TF")

# STATS POST-HOC -- FCM Tukeys ----------------------------------------------------------
# Tukey growth rates for the first half of the expierment
tukey_model_fcm &lt;-fcm_stats_df%&gt;%
  group_by(test, DayNight)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~aov(log_value ~ Organism, .x)%&gt;%
                      TukeyHSD(p.adjust.methods = "BH")%&gt;%
                      tidy()))%&gt;%
  unnest(data)%&gt;%
  filter(adj.p.value &lt; 0.05)

# STATS POST-HOC — Timepoint anovas ---------------------------------------
aov_time &lt;- dom_timepoint%&gt;%
  group_by(Organism, feature_number, DayNight)%&gt;%
  nest()%&gt;%
  mutate(anova = map(data, ~ aov(asin ~ Timepoint, .x)%&gt;%
                       glance()%&gt;%
                       dplyr::select(p.value)))%&gt;%
  dplyr::select(-data)%&gt;%
  unnest(anova)%&gt;%
  ungroup()%&gt;%   
  add_column(FDR = p.adjust(.$p.value, method = "BH"))

# STATS P-VALUE -- Timepoint anovas --------------------------------------------------------
time_aov_sigs &lt;- aov_time%&gt;%
  filter(FDR &lt; 0.05)%&gt;%
  unite(combined, c(Organism, feature_number, DayNight), sep = "_", remove = TRUE)%&gt;%
  dplyr::select(-p.value)

time_aov_sig_features &lt;- as.vector(time_aov_sigs$combined)


# STATS POST-HOC -- compounds Dunnetts -------------------------------------------------------------
organism_order &lt;- as.factor(dom_organism_post_hoc$Organism)%&gt;%
  relevel("Water control")%&gt;%
  levels()%&gt;%
  as.vector()

org_dunnetts_exudates &lt;- dom_organism_post_hoc%&gt;%
  group_by(Timepoint, DayNight, feature_number)%&gt;%
  mutate(sum = sum(asin))%&gt;%
  filter(!sum == 0)%&gt;%
  dplyr::select(-sum)%&gt;%
  ungroup()%&gt;%
  mutate(Organism = factor(Organism))%&gt;%
  mutate(Organism = fct_relevel(Organism, organism_order))%&gt;%
  group_by(Timepoint, feature_number, DayNight)%&gt;%
  nest()%&gt;%
  mutate(dunnett = map(data, ~ aov(asin ~ Organism, .x)%&gt;%
                         glht(linfct = mcp(Organism = "Dunnett"))),
         dunnett_summary = map(dunnett, ~summary(.x)%&gt;%
                                 tidy()))
         # tukey = map(data, ~ aov(asin ~ Organism, .x)%&gt;%
         #             glht(linfct = mcp(Tension = "Tukey"))))

##Doing future_mapping across processors. Seems to take longer when you have a lot of map functions.
# org_dunnetts_exudates &lt;- dom_organism_post_hoc%&gt;%
#   group_by(Timepoint, DayNight, feature_number)%&gt;%
#   mutate(sum = sum(asin))%&gt;%
#   filter(!sum == 0)%&gt;%
#   dplyr::select(-sum)%&gt;%
#   ungroup()%&gt;%
#   mutate(Organism = factor(Organism))%&gt;%
#   mutate(Organism = fct_relevel(Organism, organism_order))%&gt;%
#   group_by(Timepoint, feature_number, DayNight)%&gt;%
#   nest()%&gt;%
#   mutate(dunnett = future_map(data, ~ aov(asin ~ Organism, .x)%&gt;%
#                                 glht(linfct = mcp(Organism = "Dunnett"))),
#          dunnett_summary = future_map(dunnett, ~ summary(.x)%&gt;%
#                                 tidy()),
#          tukey = future_map(data, ~ aov(asin ~ Organism, .x)%&gt;%
#                               glht(linfct = mcp(tension = "Tukey")))) #switched out map with future_map



# STATS P-VALUE -- compounds Dunnetts ----------------------------
dunnets_pvals &lt;- org_dunnetts_exudates%&gt;%
  dplyr::select(c(1:3, dunnett_summary))%&gt;%
  unnest(dunnett_summary)%&gt;%
  dplyr::select(-c(5:8))%&gt;%
  ungroup()%&gt;%
  add_column(FDR = p.adjust(.$p.value, method = "BH"))%&gt;%
  filter(FDR &lt; 0.05)%&gt;%
  mutate(lhs = gsub(" - Water control", "", lhs))%&gt;%
  unite(combined, c(lhs, feature_number, DayNight), sep = "_")

significant_exudates &lt;- dunnets_pvals%&gt;%
  filter(Timepoint == "T0")

significant_accumulites &lt;- dunnets_pvals%&gt;%
  filter(Timepoint == "TF")

# STATS POST-HOC -- MICROBES Dunnetts -----------------------------
organism_order_micro &lt;- as.factor(mic_organism_post_hoc$Organism)%&gt;%
  relevel("Water control")%&gt;%
  levels()%&gt;%
  as.vector()

dunnett_microbe_pvals &lt;- mic_organism_post_hoc%&gt;%
  group_by(DayNight, OTU)%&gt;%
  mutate(sum = sum(asin))%&gt;%
  filter(sum != 0)%&gt;%
  dplyr::select(-sum)%&gt;%
  mutate(Organism = factor(Organism))%&gt;%
  mutate(Organism = fct_relevel(Organism, organism_order_micro))%&gt;%
  nest()%&gt;%
  mutate(dunnett = map(data, ~ aov(asin ~ Organism, .x)%&gt;%
                         glht(linfct = mcp(Organism = "Dunnett"))),
         dunnett_summary = map(dunnett, ~summary(.x)%&gt;%
                                 tidy()))%&gt;%
  dplyr::select(-c(data,dunnett))%&gt;%
  unnest(dunnett_summary)%&gt;%
  dplyr::select(-c(4:7))%&gt;%
  mutate(lhs = gsub(" - Water control", "", lhs))%&gt;%
  rename("Organism" = "lhs")%&gt;%
  ungroup()%&gt;%   
  add_column(FDR = p.adjust(.$p.value, method = "BH"))%&gt;%
  filter(FDR &lt; 0.05)

# STATS POST-HOC -- DayNight MICROBES t-test organism --------------------
daynight_microbe_pvals &lt;- mic_organism_post_hoc%&gt;%
  group_by(Organism, OTU)%&gt;%
  mutate(sum = sum(asin))%&gt;%
  filter(sum != 0)%&gt;%
  dplyr::select(-sum)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~ aov(asin ~ DayNight, .x)%&gt;%
                       tidy()))%&gt;%
  unnest(data)%&gt;%
  dplyr::select(-c(4:7))%&gt;%
  filter(term != "Residuals")%&gt;%
  ungroup()%&gt;%   
  add_column(FDR = p.adjust(.$p.value, method = "BH"))%&gt;%
  filter(FDR &lt; 0.05)

# POST-CLEANING -- benthic exudates column --------------------------------
benthic_exudates &lt;- significant_exudates$feature_number

microbial_accumulite &lt;- significant_accumulites$feature_number

networking &lt;- networking%&gt;%
  mutate(benthic_exudate = case_when(feature_number %in% benthic_exudates ~ "benthic_exudate",
                                     TRUE ~ "background"),
         microbial_accumulite = case_when(feature_number %in% microbial_accumulite ~ "microbial_accumulite",
                                          TRUE ~ "background"))
# META-STATS -- microbes --------------------------------------------------
dunnett_micro_analysis &lt;- dunnett_microbe_pvals%&gt;%
  dplyr::select(-p.value)%&gt;%
  spread(Organism, FDR)%&gt;%
  add_column(number_exudate_organisms = rowSums(.[3:ncol(.)] &gt;= 0, na.rm = TRUE))%&gt;%
  mutate(microbe_organism = case_when(is.na(CCA) == FALSE &amp; 
                                        is.na(Dictyota) &amp;
                                        is.na(Turf) &amp;
                                        is.na(`Pocillopora verrucosa`)  &amp;
                                        is.na(`Porites lobata`) ~ "CCA",
                                      is.na(CCA)  &amp; 
                                        is.na(Dictyota) == FALSE &amp;
                                        is.na(Turf) &amp;
                                        is.na(`Pocillopora verrucosa`)  &amp;
                                        is.na(`Porites lobata`) ~ "Dictyota",
                                      is.na(CCA)  &amp; 
                                        is.na(Dictyota) &amp;
                                        is.na(Turf) == FALSE &amp;
                                        is.na(`Pocillopora verrucosa`)  &amp;
                                        is.na(`Porites lobata`) ~ "Turf",
                                      is.na(CCA) &amp; 
                                        is.na(Dictyota) &amp;
                                        is.na(Turf) &amp;
                                        is.na(`Pocillopora verrucosa`) == FALSE &amp;
                                        is.na(`Porites lobata`) ~ "Pocillopora verrucosa",
                                      is.na(CCA) &amp; 
                                        is.na(Dictyota) &amp;
                                        is.na(Turf) &amp;
                                        is.na(`Pocillopora verrucosa`)  &amp;
                                        is.na(`Porites lobata`) == FALSE ~ "Porites lobata",
                                      is.na(`Pocillopora verrucosa`) == FALSE &amp;
                                        is.na(CCA) == FALSE &amp; 
                                        is.na(Dictyota) &amp;
                                        is.na(Turf)  |
                                        is.na(`Porites lobata`) == FALSE &amp;
                                        is.na(CCA) == FALSE &amp;
                                        is.na(Dictyota) &amp;
                                        is.na(Turf) ~ "Corraline",
                                      is.na(`Pocillopora verrucosa`) &amp;
                                        is.na(CCA) == FALSE &amp; 
                                        is.na(Dictyota) == FALSE &amp;
                                        is.na(`Porites lobata`) |
                                        is.na(CCA) == FALSE &amp;
                                        is.na(Turf) == FALSE &amp;
                                        is.na(`Porites lobata`) &amp;
                                        is.na(`Pocillopora verrucosa`) ~ "Algae",
                                      is.na(`Dictyota`) &amp;
                                        is.na(CCA)  &amp;
                                        is.na(Turf) &amp;
                                        is.na(`Porites lobata`) == FALSE &amp;
                                        is.na(`Pocillopora verrucosa`) == FALSE ~ "Coral",
                                      is.na(`Dictyota`) == FALSE &amp;
                                        is.na(CCA)  &amp;
                                        is.na(Turf) == FALSE &amp;
                                        is.na(`Porites lobata`) &amp;
                                        is.na(`Pocillopora verrucosa`) ~ "Fleshy Algae",
                                      is.na(CCA)  &amp; 
                                        is.na(Dictyota) &amp;
                                        is.na(Turf) == FALSE &amp;
                                        is.na(`Pocillopora verrucosa`)  &amp;
                                        is.na(`Porites lobata`) ~ "Turf",
                                      number_exudate_organisms &gt; 3 ~ "Primary Producers",
                                      TRUE ~ "Cosmo"))

micro_sigs_vector &lt;- as.vector(dunnett_micro_analysis$OTU)

# META-STATS Random Forest -- microbes ------------------------------------------
rf_microbe_prep &lt;- microbe_no_rare%&gt;%
  filter(Timepoint == "TF")%&gt;%
  select(c(1:6, OTU, asin))%&gt;%
  filter(OTU %in% micro_sigs_vector)%&gt;%
  # group_by(Organism, Replicate, Timepoint, DayNight, OTU)%&gt;%
  # summarize_if(is.numeric, sum)%&gt;%
  # ungroup()%&gt;%
  spread(OTU, asin)%&gt;%
  select(Organism, DayNight, 7:ncol(.))%&gt;%
  mutate(Organism = as.factor(Organism))

names(rf_microbe_prep) &lt;- make.names(names(rf_microbe_prep))

rf_microbe &lt;- rf_microbe_prep%&gt;%
  group_by(DayNight)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~randomForest(Organism ~ ., .x,
                                        importance = TRUE, proximity = TRUE,
                                        ntree = 5000, na.action=na.exclude)),
         mda = map(data, ~ .x$importance%&gt;%
                     as.data.frame()%&gt;%
                     rownames_to_column("otu")))

rf_microbe_mda &lt;- rf_microbe%&gt;%
  select(DayNight, mda)%&gt;%
  unnest(mda)
  

pdf("~/Documents/GitHub/DORCIERR/data/plots/microbe_mda.pdf", width = 7, height = 5)
rf_microbe_mda%&gt;%
  filter(DayNight == "Day")%&gt;%
  ggplot(., aes(x= reorder(otu, -MeanDecreaseAccuracy), y = MeanDecreaseAccuracy)) +
  geom_point(stat = "identity") +
  ggtitle("Day") +
  geom_hline(yintercept = (top_n(rf_microbe_mda%&gt;%
                                   filter(DayNight=="Day"), 30, MeanDecreaseAccuracy)%&gt;%
                             arrange(-MeanDecreaseAccuracy))$MeanDecreaseAccuracy[30],
             col = "red") +
  theme(
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major.x = element_line(size = 0.2, linetype = 'solid',colour = "gray"), 
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"), # get rid of legend panel bg
    legend.text = element_text(face = "italic")) +
  scale_x_discrete(breaks = seq(0, 568, 50))

rf_microbe_mda%&gt;%
  filter(DayNight == "Night")%&gt;%
  ggplot(., aes(x= reorder(otu, -MeanDecreaseAccuracy), y = MeanDecreaseAccuracy)) +
  geom_point(stat = "identity") +
  ggtitle("Night") +
  geom_hline(yintercept = (top_n(rf_microbe_mda%&gt;%
                                   filter(DayNight=="Night"), 35, MeanDecreaseAccuracy)%&gt;%
                             arrange(-MeanDecreaseAccuracy))$MeanDecreaseAccuracy[30],
             col = "red") +
  theme(
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major.x = element_line(size = 0.2, linetype = 'solid',colour = "gray"), 
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"), # get rid of legend panel bg
    legend.text = element_text(face = "italic")) +
  scale_x_discrete(breaks = seq(0, 568, 50))
dev.off()

rf_microbe_sigs &lt;- (rf_microbe_mda%&gt;%
  group_by(DayNight)%&gt;%
  nest()%&gt;%
    mutate(dic = map(data, ~ top_n(.x, 20, Dictyota)%&gt;%
                       select(otu)),
           cca = map(data, ~ top_n(.x, 20, CCA)%&gt;%
                       select(otu)),
           trf = map(data, ~ top_n(.x, 20, Turf)%&gt;%
                       select(otu)),
           poc = map(data, ~ top_n(.x, 20, `Pocillopora verrucosa`)%&gt;%
                       select(otu)),
           por = map(data, ~ top_n(.x, 20, `Porites lobata`)%&gt;%
                       select(otu)),
           wat = map(data, ~ top_n(.x, 20, `Water control`)%&gt;%
                       select(otu)))%&gt;%
    select(-data)%&gt;%
    gather(species, importance, dic:wat)%&gt;%
    unnest(importance))$otu%&gt;%
  as.vector()%&gt;%
  unique()

# META-STATS -- labile compounds --------------------------------------------------------
## These are defined as features which are present in T0 for any organism and then decrease from T0 -&gt; TF
time_sigs_decrease &lt;- inner_join(time_aov_sigs, decrease_over_time, by = "combined")
dunnett_exudates &lt;- inner_join(exudate, significant_exudates, by = "combined")

labile_exudates &lt;- inner_join(time_sigs_decrease, dunnett_exudates, by = "combined", suffix = c(".time", ".dunnetts"))%&gt;%
  separate(combined, c("Organism", "feature_number", "DayNight"), sep = "_")%&gt;%
  dplyr::select(1:3, FDR.dunnetts)%&gt;%
  group_by(DayNight)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~ spread(.x, Organism, FDR.dunnetts)%&gt;%
                      add_column(number_exudate_organisms = rowSums(.[2:ncol(.)] &gt;= 0, na.rm = TRUE))%&gt;%
                      mutate(exudate_type = case_when(is.na(CCA) == FALSE &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) &amp;
                                                        is.na(`Pocillopora verrucosa`)  &amp;
                                                        is.na(`Porites lobata`) ~ "CCA",
                                                      is.na(CCA)  &amp; 
                                                        is.na(Dictyota) == FALSE &amp;
                                                        is.na(Turf) &amp;
                                                        is.na(`Pocillopora verrucosa`)  &amp;
                                                        is.na(`Porites lobata`) ~ "Dictyota",
                                                      is.na(CCA)  &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) == FALSE &amp;
                                                        is.na(`Pocillopora verrucosa`)  &amp;
                                                        is.na(`Porites lobata`) ~ "Turf",
                                                      is.na(CCA) &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) &amp;
                                                        is.na(`Pocillopora verrucosa`) == FALSE &amp;
                                                        is.na(`Porites lobata`) ~ "Pocillopora verrucosa",
                                                      is.na(CCA) &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) &amp;
                                                        is.na(`Pocillopora verrucosa`)  &amp;
                                                        is.na(`Porites lobata`) == FALSE ~ "Porites lobata",
                                                      is.na(`Pocillopora verrucosa`) == FALSE &amp;
                                                        is.na(CCA) == FALSE &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf)  |
                                                        is.na(`Porites lobata`) == FALSE &amp;
                                                        is.na(CCA) == FALSE &amp;
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) ~ "Corraline",
                                                      is.na(`Pocillopora verrucosa`) &amp;
                                                        is.na(CCA) == FALSE &amp; 
                                                        is.na(Dictyota) == FALSE &amp;
                                                        is.na(`Porites lobata`) |
                                                        is.na(CCA) == FALSE &amp;
                                                        is.na(Turf) == FALSE &amp;
                                                        is.na(`Porites lobata`) &amp;
                                                        is.na(`Pocillopora verrucosa`) ~ "Algae",
                                                      is.na(`Dictyota`) &amp;
                                                        is.na(CCA)  &amp;
                                                        is.na(Turf) &amp;
                                                        is.na(`Porites lobata`) == FALSE &amp;
                                                        is.na(`Pocillopora verrucosa`) == FALSE ~ "Coral",
                                                      is.na(`Dictyota`) == FALSE &amp;
                                                        is.na(CCA)  &amp;
                                                        is.na(Turf) == FALSE &amp;
                                                        is.na(`Porites lobata`) &amp;
                                                        is.na(`Pocillopora verrucosa`) ~ "Fleshy Algae",
                                                      is.na(CCA)  &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) == FALSE &amp;
                                                        is.na(`Pocillopora verrucosa`)  &amp;
                                                        is.na(`Porites lobata`) ~ "Turf",
                                                      number_exudate_organisms &gt; 3 ~ "Primary Producers",
                                                      TRUE ~ "Cosmo"))))%&gt;%
  unnest(data)%&gt;%
  add_column(lability = "labile")

labile_exudates_vector &lt;- as.vector(labile_exudates$feature_number)%&gt;%
  unique()
combined_labile_compounds &lt;- right_join(networking, labile_exudates, by = "feature_number")

# META-STATS -- accumulating compounds -------------
## Binning compounds different in remins by produced compounds 
time_sigs_increase &lt;- inner_join(time_aov_sigs, increase_over_time, by = "combined")
dunnett_higher_than_h20 &lt;- inner_join(accumulites, significant_accumulites, by = "combined")

accumulating_exudates &lt;- inner_join(time_sigs_increase, dunnett_higher_than_h20, by = "combined", suffix = c(".time", ".dunnetts"))%&gt;%
  separate(combined, c("Organism", "feature_number", "DayNight"), sep = "_")%&gt;%
  dplyr::select(1:3, FDR.dunnetts)%&gt;%
  group_by(DayNight)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~ spread(.x, Organism, FDR.dunnetts)%&gt;%
                      add_column(number_exudate_organisms = rowSums(.[2:ncol(.)] &gt;= 0, na.rm = TRUE))%&gt;%
                      mutate(exudate_type = case_when(is.na(CCA) == FALSE &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) &amp;
                                                        is.na(`Pocillopora verrucosa`)  &amp;
                                                        is.na(`Porites lobata`) ~ "CCA",
                                                      is.na(CCA)  &amp; 
                                                        is.na(Dictyota) == FALSE &amp;
                                                        is.na(Turf) &amp;
                                                        is.na(`Pocillopora verrucosa`)  &amp;
                                                        is.na(`Porites lobata`) ~ "Dictyota",
                                                      is.na(CCA)  &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) == FALSE &amp;
                                                        is.na(`Pocillopora verrucosa`)  &amp;
                                                        is.na(`Porites lobata`) ~ "Turf",
                                                      is.na(CCA) &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) &amp;
                                                        is.na(`Pocillopora verrucosa`) == FALSE &amp;
                                                        is.na(`Porites lobata`) ~ "Pocillopora verrucosa",
                                                      is.na(CCA) &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) &amp;
                                                        is.na(`Pocillopora verrucosa`)  &amp;
                                                        is.na(`Porites lobata`) == FALSE ~ "Porites lobata",
                                                      is.na(`Pocillopora verrucosa`) == FALSE &amp;
                                                        is.na(CCA) == FALSE &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf)  |
                                                        is.na(`Porites lobata`) == FALSE &amp;
                                                        is.na(CCA) == FALSE &amp;
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) ~ "Corraline",
                                                      is.na(`Pocillopora verrucosa`) &amp;
                                                        is.na(CCA) == FALSE &amp; 
                                                        is.na(Dictyota) == FALSE &amp;
                                                        is.na(`Porites lobata`) |
                                                        is.na(CCA) == FALSE &amp;
                                                        is.na(Turf) == FALSE &amp;
                                                        is.na(`Porites lobata`) &amp;
                                                        is.na(`Pocillopora verrucosa`) ~ "Algae",
                                                      is.na(`Dictyota`) &amp;
                                                        is.na(CCA)  &amp;
                                                        is.na(Turf) &amp;
                                                        is.na(`Porites lobata`) == FALSE &amp;
                                                        is.na(`Pocillopora verrucosa`) == FALSE ~ "Coral",
                                                      is.na(`Dictyota`) == FALSE &amp;
                                                        is.na(CCA)  &amp;
                                                        is.na(Turf) == FALSE &amp;
                                                        is.na(`Porites lobata`) &amp;
                                                        is.na(`Pocillopora verrucosa`) ~ "Fleshy Algae",
                                                      is.na(CCA)  &amp; 
                                                        is.na(Dictyota) &amp;
                                                        is.na(Turf) == FALSE &amp;
                                                        is.na(`Pocillopora verrucosa`)  &amp;
                                                        is.na(`Porites lobata`) ~ "Turf",
                                                      number_exudate_organisms &gt; 3 ~ "Primary Producers",
                                                      TRUE ~ "Cosmo"))))%&gt;%
  unnest(data)%&gt;%
  add_column(lability = "accumulite")


accumulite_exudates_vector &lt;- as.vector(accumulating_exudates$feature_number)%&gt;%
  unique()
combined_accumulite_compounds &lt;- right_join(networking, accumulating_exudates, by = "feature_number")




# META-STATS Random Forest -- Labile accumulites -----------------------------
labile_accumulites_vector &lt;- c(labile_exudates_vector, accumulite_exudates_vector)%&gt;%
  unique()

rf_labile_prep &lt;- dom_organism_post_hoc%&gt;%
  filter(feature_number %in% labile_accumulites_vector)%&gt;%
  spread(Timepoint, asin)%&gt;%
  group_by(Organism, DayNight, feature_number)%&gt;%
  mutate(mean_t0 = mean(T0, na.rm = TRUE),
         feature_difference = TF-mean_t0)%&gt;%
  ungroup()%&gt;%
  select(-c(T0, mean_t0, TF))%&gt;%
  spread(feature_number, feature_difference)%&gt;%
  select(-c(Replicate, Experiment))%&gt;%
  mutate(Organism = as.factor(Organism))
  

names(rf_labile_prep) &lt;- make.names(names(rf_labile_prep))

rf_labile &lt;- rf_labile_prep%&gt;%
  group_by(DayNight)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~randomForest(Organism ~ ., .x,
                                        importance = TRUE, proximity = TRUE,
                                        ntree = 5000, na.action=na.exclude)),
         mda = map(data, ~ .x$importance%&gt;%
                     as.data.frame()%&gt;%
                     rownames_to_column("otu")))

rf_labile_mda &lt;- rf_labile%&gt;%
  select(DayNight, mda)%&gt;%
  unnest(mda)

rf_compound_sigs &lt;- (rf_labile_mda%&gt;%
                       group_by(DayNight)%&gt;%
                       nest()%&gt;%
                       mutate(dic = map(data, ~ top_n(.x, 10, Dictyota)%&gt;%
                                          select(otu)),
                              cca = map(data, ~ top_n(.x, 10, CCA)%&gt;%
                                          select(otu)),
                              trf = map(data, ~ top_n(.x, 10, Turf)%&gt;%
                                          select(otu)),
                              poc = map(data, ~ top_n(.x, 10, `Pocillopora verrucosa`)%&gt;%
                                          select(otu)),
                              por = map(data, ~ top_n(.x, 10, `Porites lobata`)%&gt;%
                                          select(otu)),
                              wat = map(data, ~ top_n(.x, 10, `Water control`)%&gt;%
                                          select(otu)))%&gt;%
                       select(-data)%&gt;%
                       gather(species, importance, dic:wat)%&gt;%
                       unnest(importance)%&gt;%
                       mutate(otu = gsub("X", "", otu)))$otu%&gt;%
  as.vector()%&gt;%
  unique()

rf_labile_mda%&gt;%
  filter(DayNight == "Night")%&gt;%
  ggplot(., aes(x= reorder(otu, -MeanDecreaseAccuracy), y = MeanDecreaseAccuracy)) +
  geom_point(stat = "identity") +
  ggtitle("Night") +
  geom_hline(yintercept = (top_n(rf_labile_mda%&gt;%
                                   filter(DayNight=="Night"), 35, MeanDecreaseAccuracy)%&gt;%
                             arrange(-MeanDecreaseAccuracy))$MeanDecreaseAccuracy[35],
             col = "red") +
  theme(
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major.x = element_line(size = 0.2, linetype = 'solid', colour = "gray"), 
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"), # get rid of legend panel bg
    legend.text = element_text(face = "italic")) +
  scale_x_discrete(breaks = seq(0, 568, 50))

# META-STATS —- Labile + Accumulating compounds ------------------------------
# combined_labile_accumulites_compounds &lt;- bind_rows(combined_accumulite_compounds,combined_labile_compounds)%&gt;%
#   dplyr::select(feature_number, exudate_type, lability, everything())

# META-STATS -- correlation matrix ----------------------------------------
## Correlation between microbe abundance TF and the change in feature abundance from mean(T0) to TF
correlation_microbe&lt;-mic_organism_post_hoc%&gt;%
  filter(OTU %in% micro_sigs_vector)%&gt;%
  dplyr::select(-c(sample_code, Experiment, Timepoint, 7:9, 11:18))%&gt;%
  unite(sample, c("Organism", "DayNight", "Replicate"), sep = "_")%&gt;%
  spread(OTU, asin)

correlation_labile &lt;- dom_organism_post_hoc%&gt;%
  filter(feature_number %in% labile_exudates_vector)%&gt;%
  spread(Timepoint, asin)%&gt;%
  group_by(Organism, DayNight, feature_number)%&gt;%
  mutate(mean_t0 = mean(T0, na.rm = TRUE),
         feature_difference = TF-mean_t0)%&gt;%
  ungroup()%&gt;%
  unite(sample, c("Organism", "DayNight", "Replicate"), sep = "_")%&gt;%
  dplyr::select(-c(TF, T0, mean_t0, Experiment))%&gt;%
  spread(feature_number, feature_difference)

## Only run this section if you are prepared to wait for a long time
correlation_microbe_labile &lt;- correlation_microbe%&gt;%
  left_join(., correlation_labile, by = "sample")%&gt;%
  gather(OTU, microbe_asin, 2:71)%&gt;%
  mutate(microbe_zscore = zscore(microbe_asin))%&gt;%
  gather(feature_number, feature_asin, 2:457)%&gt;%
  mutate(feature_zscore = zscore(feature_asin))%&gt;%
  separate(sample, c("Organism", "DayNight", "Replicate"), sep = "_")

# corr_test &lt;- correlation_microbe_labile%&gt;%
#   group_by(OTU, feature_number)%&gt;%
#   nest()%&gt;%
#   mutate(data = map(data, ~ cor.test(.x$feature_zscore, .x$microbe_zscore, method = "pearson")%&gt;%
#                              broom::tidy()))
# 
# correlation_pvalues &lt;- corr_test%&gt;%
#   unnest(data)%&gt;%
#   ungroup()%&gt;%
#   add_column(FDR = p.adjust(.$p.value, method = "BH"))%&gt;%
#   filter(FDR &lt; 0.05)
# 
# correlation_vector &lt;- (correlation_pvalues%&gt;%
#   unite(compound, c(OTU, feature_number), sep = "_"))$compound%&gt;%
#   as.vector()
# 
# correlation_microbe_labile%&gt;%
#   unite(compound, c(OTU, feature_number), sep = "_", remove = FALSE)%&gt;%
#   filter(compound %in% correlation_vector)%&gt;%
#   select(-Replicate)%&gt;%
#   group_by(Organism, DayNight, compound)%&gt;%
#   summarize_if(is.numeric, mean)%&gt;%
#   ggplot(aes(microbe_zscore, feature_zscore, col = Organism)) +
#   geom_point(stat = "identity")
# 
# correlation_network &lt;- correlation_pvalues%&gt;%
#   left_join(networking, by = "feature_number")%&gt;%
#   left_join(combined_labile_compounds%&gt;%
#               select(feature_number, exudate_type), by = "feature_number")
# 


# META-STATS -- Hierarchical cluster matrix----------------------------------------
hc_microbe &lt;- mic_organism_post_hoc%&gt;%
  filter(OTU %in% rf_microbe_sigs)%&gt;%
  ungroup()%&gt;%
  group_by(OTU)%&gt;%
  mutate(zscore = zscore(asin))%&gt;%
  ungroup()%&gt;%
  dplyr::select(c(Organism, DayNight, Replicate, OTU, zscore))%&gt;%
  unite(sample, c("Organism", "DayNight", "Replicate"), sep = "_")%&gt;%
  left_join(microbe_taxonomy, by = "OTU")%&gt;%
  separate(Taxonomy, c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "OTU_id"), sep = ";")%&gt;%
  unite(OFGO, c("Order", "Family", "Genus", "OTU"), sep = ";")%&gt;%
  select(-c(Size, OTU_id, Kingdom, Phylum, Class))%&gt;%
  spread(OFGO, zscore)

hc_compounds &lt;- dom_organism_post_hoc%&gt;%
  filter(feature_number %in% rf_compound_sigs)%&gt;%
  spread(Timepoint, asin)%&gt;%
  group_by(Organism, DayNight, feature_number)%&gt;%
  mutate(mean_t0 = mean(T0, na.rm = TRUE),
         feature_difference = TF-mean_t0)%&gt;%
  ungroup()%&gt;%
  group_by(feature_number)%&gt;%
  mutate(zscore = zscore(feature_difference))%&gt;%
  ungroup()%&gt;%
  left_join(networking%&gt;%
              select(feature_number, combined_ID), 
            by = "feature_number")%&gt;%
  unite(sample, c("Organism", "DayNight", "Replicate"), sep = "_")%&gt;%
  unite(feature, c(feature_number, combined_ID), sep = "_")%&gt;%
  dplyr::select(-c(TF, T0, mean_t0, Experiment, feature_difference))%&gt;%
  spread(feature, zscore)

hc_df &lt;- hc_compounds%&gt;%
  left_join(hc_microbe, by = "sample")

write_csv(hc_df%&gt;%
            select(everything(), sample), "~/Documents/GitHub/DORCIERR/data/plots/combined_hc_df.csv")
# GRAPHING —- PCoAs DOM --------------------------------------
#looking at exudate features
dom_pco &lt;- dom_stats_wdf%&gt;%
  filter(!feature_number %like% "%-like",
         !feature_number == "DOC",
         feature_number %in% labile_exudates_vector)%&gt;%
  spread(Timepoint, asin)%&gt;%
  group_by(feature_number, Organism, DayNight)%&gt;%
  mutate(mean_t0 = mean(T0, na.rm = TRUE))%&gt;%
  mutate(change = TF - mean_t0)%&gt;%
  ungroup()%&gt;%
  mutate(zscore = ((change - mean(change, na.rm = TRUE))/sd(change, na.rm = TRUE)))%&gt;%
  mutate(zscore = zscore + 40)%&gt;%
  select(-c(TF, T0, mean_t0, change))

dom_graphing &lt;- dom_pco%&gt;%
  spread(5,6)
  
dorc_all_pcoa &lt;- dom_pco%&gt;%
  unite(sample, c(1:4), sep = "_")%&gt;%
  spread(2,3)%&gt;%
  column_to_rownames(var = "sample")%&gt;%
  vegdist(na.rm = TRUE)%&gt;%
  pcoa()
  

#This plots Eigenvalues
dorc_all_pcoa$values[1:10,]%&gt;%
  as.data.frame()%&gt;%
  rownames_to_column("Axis")%&gt;%
  mutate(axis = as.numeric(Axis))%&gt;%
  ggplot(aes(reorder(Axis, axis), Relative_eig, label = round(Relative_eig, digits = 3))) +
  geom_bar(stat = "identity") +
  geom_text(size = 3, color = "red", vjust = -0.5)

# S3 method for pcoa
pco_scores_all &lt;- dorc_all_pcoa$vectors%&gt;%
  as.data.frame()%&gt;%
  rownames_to_column(var = "sample")%&gt;%
  mutate(feature = "all")%&gt;%
  separate(sample, c("experiemnt", "Organism", "replicate", "DayNight"), sep = "_")

# Dorc_all_labile_exudates plot
pdf("./plots/dom_pcoa.pdf", width = 6, height = 5)
dorc_all_pcoa$vectors%&gt;%
  as.data.frame()%&gt;%
  rownames_to_column(var = "sample")%&gt;%
  separate(sample, c("experiemnt", "Organism", "replicate", "DayNight"), sep = "_")%&gt;%
  ggplot(., aes(x = Axis.1, y = Axis.2, color = Organism, shape = DayNight)) +
  geom_point(stat = "identity", aes(size = 0.2)) +
  scale_shape_manual(values = c(1,19)) +
  theme(
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major.y = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of major grid
    panel.grid.major.x = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"), # get rid of legend panel bg
    legend.text = element_text(face = "italic")) +
  xlab(str_c("Axis 1", " (", round(dorc_all_pcoa$values$Relative_eig[1], digits = 4)*100, "%)", sep = "")) +
  ylab(str_c("Axis 2", " (", round(dorc_all_pcoa$values$Relative_eig[2], digits = 4)*100, "%)", sep = "")) +
  ggtitle("Labile Exudates")
dev.off()
## split between day and night
# dorc_split &lt;- dom_pco%&gt;%
#   group_by(DayNight)%&gt;%
#   nest()%&gt;%
#   mutate(data = map(data, ~ unite(.x, sample, c(1:3), sep = "_")%&gt;%
#                              spread(2,3)%&gt;%
#                              column_to_rownames(var = "sample")%&gt;%
#                              vegdist(na.rm = TRUE)%&gt;%
#                              pcoa()),
#          vectors = map(data, ~ .x$vectors%&gt;%
#                          as.data.frame()%&gt;%
#                          rownames_to_column(var = "sample")))
# 
# dorc_split_vectors &lt;- dorc_split%&gt;%
#   dplyr::select(-data)%&gt;%
#   unnest(vectors)%&gt;%
#   mutate(feature = DayNight)%&gt;%
#   separate(sample, c("experiment", "Organism", "replicate", "Timepoint"), sep = "_")
# 
# 
# pco_all &lt;- bind_rows(pco_scores_all, dorc_split_vectors)%&gt;%
#   mutate(dorc_shape = case_when(DayNight == "Day" ~ 1,
#                                 DayNight == "Night" ~ 19,
#                                 TRUE ~ 3))
# 
# pdf("pcoa_all.pdf", width = 6, height = 5)
# pco_all%&gt;%
#   split(.$feature)%&gt;%
#   map(~ ggplot(., aes(x = Axis.1, y = Axis.2, color = Organism, shape = DayNight)) +
#         geom_point(stat = "identity", aes(size = 0.2)) +
#         scale_shape_manual(values = .$dorc_shape) +
#         ggtitle(.$feature) +
#         theme(
#           panel.background = element_rect(fill = "transparent"), # bg of the panel
#           plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
#           panel.grid.major.y = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of major grid
#           panel.grid.major.x = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of minor grid
#           legend.background = element_rect(fill = "transparent"), # get rid of legend bg
#           legend.box.background = element_rect(fill = "transparent"), # get rid of legend panel bg
#           legend.text = element_text(face = "italic")) +
#         xlab("Axis 1") +
#         ylab("Axis 2"))
# dev.off()


# GRAPHING -- PCoA's Microbes ---------------------------------------------
pcoa_microbe &lt;- microbe_no_rare%&gt;%
  # filter(OTU %in% micro_sigs_vector)%&gt;%
  filter(Timepoint == "TF")%&gt;%
  unite(sample, c(Organism, DayNight, Replicate), sep = "_")%&gt;%
  select(-c(sample_code, Experiment, Timepoint,
            numOtus, sum, reads, ra))%&gt;%
  group_by(sample, OTU)%&gt;%
  summarize_if(is.numeric, sum)%&gt;%
  ungroup()%&gt;%
  mutate(zscore = (asin -mean(asin))/sd(asin))%&gt;%
  mutate(zscore = zscore + 0.28)%&gt;%
  select(-asin)%&gt;%
  spread(OTU, zscore)%&gt;%
  column_to_rownames("sample")%&gt;%
  vegdist(na.rm = TRUE)%&gt;%
  pcoa()

pcoa_microbe$values[1:10,]%&gt;%
  as.data.frame()%&gt;%
  rownames_to_column("Axis")%&gt;%
  mutate(axis = as.numeric(Axis))%&gt;%
  ggplot(aes(reorder(Axis, axis), Relative_eig, label = round(Relative_eig, digits = 3))) +
  geom_bar(stat = "identity") +
  geom_text(size = 3, color = "red", vjust = -0.5)

pdf("~/Documents/GitHub/DORCIERR/data/plots/microbe_pcoa.pdf", width = 6, height = 5)
pcoa_microbe$vectors%&gt;%
  as.data.frame()%&gt;%
  rownames_to_column("sample")%&gt;%
  separate(sample, c("Organism", "DayNight", "Replicate"), sep = "_")%&gt;%
  ggplot(., aes(x = Axis.1, y = Axis.2, color = Organism, shape = DayNight)) +
  geom_point(stat = "identity", aes(size = 0.2)) +
  scale_shape_manual(values = c(1,19)) +
  theme(
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major.y = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of major grid
    panel.grid.major.x = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"), # get rid of legend panel bg
    legend.text = element_text(face = "italic")) +
  xlab(str_c("Axis 1", " (", round(pcoa_microbe$values$Relative_eig[1], digits = 4)*100, "%)", sep = "")) +
  ylab(str_c("Axis 2", " (", round(pcoa_microbe$values$Relative_eig[2], digits = 4)*100, "%)", sep = ""))
dev.off()


# GRAPHING -- PCoA's DOM and microbes -------------------------------------
## Combining microbes and compounds
pcoa_microbe_cmobine &lt;- microbe_no_rare%&gt;%
  filter(OTU %in% micro_sigs_vector)%&gt;%
  filter(Timepoint == "TF")%&gt;%
  unite(sample, c(Organism, DayNight, Replicate), sep = "_")%&gt;%
  select(-c(sample_code, Experiment, Timepoint,
            numOtus, sum, reads, ra))%&gt;%
  group_by(sample, OTU)%&gt;%
  summarize_if(is.numeric, sum)%&gt;%
  ungroup()%&gt;%
  mutate(zscore = (asin -mean(asin))/sd(asin))%&gt;%
  mutate(zscore = zscore + 0.28)%&gt;%
  select(-asin)%&gt;%
  spread(OTU, zscore)

pcoa_compounds &lt;- dom_organism_post_hoc%&gt;%
  filter(feature_number %in% accumulite_exudates_vector | feature_number %in% labile_exudates_vector)%&gt;%
  spread(Timepoint, asin)%&gt;%
  group_by(Organism, DayNight, feature_number)%&gt;%
  mutate(mean_t0 = mean(T0, na.rm = TRUE),
         feature_difference = TF-mean_t0)%&gt;%
  ungroup()%&gt;%
  group_by(feature_number)%&gt;%
  mutate(zscore = zscore(feature_difference))%&gt;%
  ungroup()%&gt;%
  left_join(networking%&gt;%
              select(feature_number, combined_ID), 
            by = "feature_number")%&gt;%
  unite(sample, c("Organism", "DayNight", "Replicate"), sep = "_")%&gt;%
  unite(feature, c(feature_number, combined_ID), sep = "_")%&gt;%
  dplyr::select(-c(TF, T0, mean_t0, Experiment, feature_difference))%&gt;%
  spread(feature, zscore)

pcoa_df &lt;- pcoa_compounds%&gt;%
  left_join(pcoa_microbe_cmobine, by = "sample")

combined_pcoa &lt;- hc_df%&gt;%
  gather(feature_number, val, 2:ncol(.))%&gt;%
  mutate(val = val + 4)%&gt;%
  spread(feature_number, val)%&gt;%
  column_to_rownames(var = "sample")%&gt;%
  vegdist()%&gt;%
  pcoa()

pdf("./plots/combined_pcoa.pdf", width = 6, height = 5)
combined_pcoa$vectors%&gt;%
  as.data.frame()%&gt;%
  rownames_to_column(var = "sample")%&gt;%
  separate(sample, c("Organism", "DayNight", "Replicate"), sep = "_")%&gt;%
  ggplot(., aes(x = Axis.1, y = Axis.2, color = Organism, shape = DayNight)) +
  geom_point(stat = "identity", aes(size = 0.2)) +
  scale_shape_manual(values = c(1,19)) +
  theme(
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major.y = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of major grid
    panel.grid.major.x = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent"), # get rid of legend panel bg
    legend.text = element_text(face = "italic")) +
  xlab(str_c("Axis 1", " (", round(dorc_all_pcoa$values$Relative_eig[1], digits = 4)*100, "%)", sep = "")) +
  ylab(str_c("Axis 2", " (", round(dorc_all_pcoa$values$Relative_eig[2], digits = 4)*100, "%)", sep = "")) +
  ggtitle("Depletolites, Microbes and Accumulites")
dev.off()

# GRAPHING -- DOC ---------------------------------------------------------
dom_stats_wdf%&gt;%
    filter(feature_number == "DOC")%&gt;%
    ggplot(aes(Organism, asin, fill = Timepoint)) +
    geom_bar(stat = "summary", fun.y = "mean",position = "dodge2") +
    facet_wrap(~DayNight) +
    theme(
      axis.text.x = element_text(angle = 60, hjust = 1),
      panel.background = element_rect(fill = "transparent"), # bg of the panel
      plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
      panel.grid.major.y = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of major grid
      panel.grid.major.x = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of minor grid
      legend.background = element_rect(fill = "transparent"), # get rid of legend bg
      legend.box.background = element_rect(fill = "transparent"))+ # get rid of legend panel bg) +
    ylab("Log10(DOC)")



# GRAPHING -- fDOM --------------------------------------------------------
dom_stats_wdf%&gt;%
    filter(feature_number %like% "%-like")%&gt;%
    split(.$feature_number)%&gt;%
    map(~ ggplot(., aes(Organism, asin, fill = Timepoint)) +
    geom_bar(stat = "summary", fun.y = "mean", position = "dodge2") +
    facet_wrap(~DayNight) +
    theme(
      axis.text.x = element_text(angle = 60, hjust = 1),
      panel.background = element_rect(fill = "transparent"), # bg of the panel
      plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
      panel.grid.major.y = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of major grid
      panel.grid.major.x = element_line(size = 0.2, linetype = 'solid',colour = "gray"), # get rid of minor grid
      legend.background = element_rect(fill = "transparent"), # get rid of legend bg
      legend.box.background = element_rect(fill = "transparent"))+ # get rid of legend panel bg) +
    ylab("fDOM")+
    ggtitle(.$feature_number))
    
  
# GRAPHING — network 141 412 testing changes ---------------------------------------------
# Not visualized in 141 == "11633",
net141 &lt;- feature_ra%&gt;%
  filter(feature_number %in% c(1:5, "11430", "12392",  "11716", "13535", "13491",  "16123", "15438",  "15198"))

net141_networking &lt;- left_join(net141, networking, by = "feature_number")%&gt;%
  rename("Feature Identification" = "combined_ID")

net412 &lt;- feature_ra%&gt;%
  filter(feature_number %in% c("18583", "19327", "19552", "5206", "5225", "7153", "7170"))

net141_xic &lt;- feature_xic%&gt;%
  filter(feature_number %in% c(1:5, "11430", "12392",  "11716", "13535", "13491",  "16123", "15438",  "15198"))

net412_xic&lt;- feature_xic%&gt;%
  filter(feature_number %in% c("18583", "19327", "19552", "5206", "5225", "7153", "7170"))


#Change over time RA
net141_cot &lt;- net141%&gt;%
  spread(Timepoint, ra)%&gt;%
  group_by(feature_number, Organism, DayNight)%&gt;%
  mutate(T0 = mean(T0, na.rm = TRUE),
         cot_per = (TF-T0)/TF,
         cot_abs = TF-T0,
         asin_T0 = asin(T0),
         asin_TF = asin(TF),
         cot_asin_per = (asin_TF-asin_T0)/asin_TF,
         cot_asin_abs = asin_TF - asin_T0,
         weighted_asin = cot_asin_per*abs(cot_asin_abs),
         weighted_ra = cot_per*abs(cot_abs))%&gt;%
  select(-c(TF, T0))

net412_cot &lt;- net412%&gt;%
  spread(Timepoint, ra)%&gt;%
  group_by(feature_number, Organism, DayNight)%&gt;%
  mutate(T0 = mean(T0, na.rm = TRUE),
         cot_per = (TF-T0)/TF,
         cot_abs = TF-T0,
         asin_T0 = asin(T0),
         asin_TF = asin(TF),
         cot_asin_per = (asin_TF-asin_T0)/asin_TF,
         cot_asin_abs = asin_TF - asin_T0,
         weighted_asin = cot_asin_per*abs(cot_asin_abs),
         weighted_ra = cot_per*abs(cot_abs))%&gt;%
  select(-c(TF, T0))

net412_xic_cot &lt;- net412_xic%&gt;%
  spread(Timepoint, xic)%&gt;%
  group_by(feature_number, Organism, DayNight)%&gt;%
  mutate(T0 = mean(T0, na.rm = TRUE),
         cot_per = (TF-T0)/T0,
         cot_abs = TF-T0,
         weighted_ra = cot_per*abs(cot_abs))%&gt;%
  select(-c(TF, T0))

net141_xic_cot &lt;- net141_xic%&gt;%
  filter(feature_number != "12392")%&gt;%
  spread(Timepoint, xic)%&gt;%
  group_by(feature_number, Organism, DayNight)%&gt;%
  mutate(T0 = mean(T0, na.rm = TRUE),
         cot_per = (TF-T0)/T0,
         cot_abs = TF-T0,
         weighted_ra = cot_per*abs(cot_abs))%&gt;%
  select(-c(TF, T0))




##Plotting
pdf("~/Documents/GitHub/DORCIERR/data/plots/why_not_change_over_time_net141_xic.pdf", width = 6, height = 5)
ggplot(net141_xic, aes(x = reorder(Organism, - xic), y = xic, fill = Timepoint))+
  geom_bar(stat = "summary", fun.y = "mean", position = "dodge")+
  facet_wrap(~DayNight) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
                panel.background = element_rect(fill = "transparent"), # bg of the panel
                plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
                panel.grid.major = element_blank(), # get rid of major grid
                panel.grid.minor = element_blank(), # get rid of minor grid
                legend.background = element_rect(fill = "transparent"), # get rid of legend bg
                legend.box.background = element_rect(fill = "transparent")) + # get rid of legend panel bg
  xlab("Organism") +
  ylab("xic") +
  ggtitle("Network 141 xic")

ggplot(net141_xic_cot, aes(x = reorder(Organism, - cot_abs), y = cot_abs, fill = feature_number))+
  geom_bar(stat = "summary", fun.y = "mean", position = "stack") +
  facet_wrap(~DayNight) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
        panel.grid.major = element_blank(), # get rid of major grid
        panel.grid.minor = element_blank(), # get rid of minor grid
        legend.background = element_rect(fill = "transparent"), # get rid of legend bg
        legend.box.background = element_rect(fill = "transparent")) + # get rid of legend panel bg
  xlab("Organism") +
  ylab("xic Change over Time") +
  ggtitle("net141 xic Change Over Time")

ggplot(net141_xic_cot, aes(x = reorder(Organism, - cot_abs), y = cot_per, fill = feature_number))+
  geom_bar(stat = "summary", fun.y = "mean", position = "stack") +
  facet_wrap(~DayNight) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
        panel.grid.major = element_blank(), # get rid of major grid
        panel.grid.minor = element_blank(), # get rid of minor grid
        legend.background = element_rect(fill = "transparent"), # get rid of legend bg
        legend.box.background = element_rect(fill = "transparent")  # get rid of legend panel bg
  ) +
  xlab("Organism") +
  ylab("Percent Change over Time") +
  ggtitle("net141 xic percent Over Time")

# ggplot(net141_xic_cot, aes(x = reorder(Organism, - cot_abs), y = cot_asin_abs, fill = feature_number))+
#   geom_bar(stat = "summary", fun.y = "mean", position = "stack")+
#   geom_bar(stat = "summary", fun.y = "mean")+
#   facet_wrap(~DayNight) +
#   theme(axis.text.x = element_text(angle = 60, hjust = 1),
#         panel.background = element_rect(fill = "transparent"), # bg of the panel
#         plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
#         panel.grid.major = element_blank(), # get rid of major grid
#         panel.grid.minor = element_blank(), # get rid of minor grid
#         legend.background = element_rect(fill = "transparent"), # get rid of legend bg
#         legend.box.background = element_rect(fill = "transparent")) + # get rid of legend panel bg
#   xlab("Organism") +
#   ylab("Asin Change over Time") +
#   ggtitle("Network 141 asin real Change Over Time")
# 
# ggplot(net141_cot, aes(x = reorder(Organism, - cot_abs), y = cot_asin_per, fill = feature_number))+
#   geom_bar(stat = "summary", fun.y = "mean", position = "stack")+
#   geom_bar(stat = "summary", fun.y = "mean")+
#   facet_wrap(~DayNight) +
#   theme(axis.text.x = element_text(angle = 60, hjust = 1),
#         panel.background = element_rect(fill = "transparent"), # bg of the panel
#         plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
#         panel.grid.major = element_blank(), # get rid of major grid
#         panel.grid.minor = element_blank(), # get rid of minor grid
#         legend.background = element_rect(fill = "transparent"), # get rid of legend bg
#         legend.box.background = element_rect(fill = "transparent")) + # get rid of legend panel bg
#   xlab("Organism") +
#   ylab("percent asin Change over Time") +
#   ggtitle("Network 141 asin percent Change Over Time")
# 
# ggplot(net141_xic_cot, aes(x = reorder(Organism, - cot_abs), y = weighted_asin, fill = feature_number))+
#   geom_bar(stat = "summary", fun.y = "mean", position = "stack")+
#   geom_bar(stat = "summary", fun.y = "mean")+
#   facet_wrap(~DayNight) +
#   theme(axis.text.x = element_text(angle = 60, hjust = 1),
#         panel.background = element_rect(fill = "transparent"), # bg of the panel
#         plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
#         panel.grid.major = element_blank(), # get rid of major grid
#         panel.grid.minor = element_blank(), # get rid of minor grid
#         legend.background = element_rect(fill = "transparent"), # get rid of legend bg
#         legend.box.background = element_rect(fill = "transparent")) + # get rid of legend panel bg
#   xlab("Organism") +
#   ylab("weighted asin Change over Time") +
#   ggtitle("net141_xic_cot weighted Change Over Time")
# 
# ggplot(net141_xic_cot, aes(x = reorder(Organism, - cot_abs), y = weighted_ra, fill = feature_number)) +
#   geom_bar(stat = "summary", fun.y = "mean", position = "stack")+
#   facet_wrap(~DayNight) +
#   theme(axis.text.x = element_text(angle = 60, hjust = 1),
#         panel.background = element_rect(fill = "transparent"), # bg of the panel
#         plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
#         panel.grid.major = element_blank(), # get rid of major grid
#         panel.grid.minor = element_blank(), # get rid of minor grid
#         legend.background = element_rect(fill = "transparent"), # get rid of legend bg
#         legend.box.background = element_rect(fill = "transparent")) + # get rid of legend panel bg
#   xlab("Organism") +
#   ylab("weighted ra Change over Time") +
#   ggtitle("Network 141 xic weighted Change Over Time")
dev.off()


net141_networking$`Feature Identification` &lt;- factor(net141_networking$`Feature Identification`,
                                                     levels = c("3-Iodo-L-tyrosine", "L-3,5-Diiodotyrosine",
                                                                "N-Acetyl-L-phenylalanyl-3,5-diiodo-L-tyrosine",
                                                                "p-Fluoro-L-phenylalanine", "2-Naphthyl-D-alanine"))

ggplot(net141_networking, aes(x = reorder(Organism, - RA), y= (RA*100), fill = `Feature Identification`)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values= c("#CB9E23", "#F8DF4F", "#1DACE8", "#7496D2", "#1C366B")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
        panel.grid.major = element_blank(), # get rid of major grid
        panel.grid.minor = element_blank(), # get rid of minor grid
        legend.background = element_rect(fill = "transparent"), # get rid of legend bg
        legend.box.background = element_rect(fill = "transparent") # get rid of legend panel bg
  ) +
  facet_grid(~ Timepoint) +
  xlab("Organism") +
  ylab("Relative Abundance (percent)")

tiff("test.tiff", units="in", width=10, height=5, res=300)
ggplot(net141_networking, aes(x = reorder(Organism, - RA), y= (RA*100), fill = `Feature Identification`)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values= c("#CB9E23", "#F8DF4F", "#1DACE8", "#7496D2", "#1C366B")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1),
        panel.background = element_rect(fill = "transparent"), # bg of the panel
        plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
        panel.grid.major = element_blank(), # get rid of major grid
        panel.grid.minor = element_blank(), # get rid of minor grid
        legend.background = element_rect(fill = "transparent"), # get rid of legend bg
        legend.box.background = element_rect(fill = "transparent") # get rid of legend panel bg
  ) +
  facet_grid(~ Timepoint) +
  xlab("Organism") +
  ylab("Relative Abundance (percent)")
dev.off()

# GRAPHING -- relative abundances of labile exudates ---------------------
# Have to classify all compounds and then add these back into the table
labile_inchikeys &lt;- combined_labile_compounds%&gt;%
  select(feature_number, inchi_combined)%&gt;%
  filter(inchi_combined != "N/A")%&gt;%
  group_by(feature_number)%&gt;%
  filter(row_number(inchi_combined) == 1 )%&gt;%
  mutate(inchi_key = cs_inchi_inchikey(inchi_combined))%&gt;%
  ungroup()

labile_classifications &lt;- labile_inchikeys%&gt;%
  select(-c(inchi_combined, feature_number))%&gt;%
  write_tsv("~/Documents/GitHub/DORCIERR/data/analysis/labile_inchikeys.tsv")

labile_classified &lt;- read_csv("~/Documents/GitHub/DORCIERR/data/analysis/labile_classyfire.csv")%&gt;%
  rename(inchi_key = 1)

labile_inchi_class &lt;- left_join(labile_inchikeys, labile_classified, by = "inchi_key")%&gt;%
  select(-c(inchi_combined, `ClassyFy Status`))

inchi_string &lt;- labile_inchi_class%&gt;%
  unite(inchi_string, c("Kingdom":"Parent Level 4"), sep = ";")%&gt;%
  mutate(inchi_string = gsub(";;", ";", inchi_string))%&gt;%
  group_by(feature_number)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~ rownames_to_column(.x, "row_select")%&gt;%
                      filter(row_select == "1")%&gt;%
                      select(-row_select)))%&gt;%
  unnest(data)%&gt;%
  ungroup()

labile_inchi_classified &lt;- labile_inchi_class%&gt;%
  gather(level, classification, 3:ncol(.))%&gt;%
  filter(!is.na(classification))%&gt;%
  mutate(level = case_when(level == "Kingdom" ~ "1",
                           level == "Superclass" ~ "2",
                           level == "Class" ~ "3",
                           level == "Subclass" ~ "4",
                           level == "Parent Level 1" ~ "5",
                           level == "Parent Level 2" ~ "6",
                           level == "Parent Level 3" ~ "7",
                           level == "Parent Level 4" ~ "8",
                           TRUE ~ as.character(level)))%&gt;%
  group_by(feature_number)%&gt;%
  nest()%&gt;%
  mutate(data = map(data, ~ filter(.x, level == max(level))%&gt;%
                      rownames_to_column("row_select")%&gt;%
                      filter(row_select == "1")%&gt;%
                      select(-row_select)))%&gt;%
  unnest(data)%&gt;%
  ungroup()%&gt;%
  select(-inchi_key)%&gt;%
  right_join(inchi_string, ., by = "feature_number")%&gt;%
  separate(inchi_string, paste("inchi", 1:8, sep = "_"), sep = ";", remove = FALSE)

# Getting ready to plot
labile_RA &lt;- feature_ra%&gt;%
  left_join(combined_labile_compounds%&gt;%
              rename(Organism = exudate_type)%&gt;%
              filter(number_exudate_organisms == 1),
            ., by = c("feature_number", "DayNight", "Organism"))%&gt;%
  filter(Timepoint == "T0")%&gt;%
  rename(`chemical composition` = simplified_makeup)%&gt;%
  add_column(color = .$`chemical composition`)%&gt;%
  mutate(color = case_when(color == "CHO" ~ "darkblue",
                           color == "CHON" ~ "#3B9AB2",
                           color == "CHN" ~ "#63ADBE",
                           color == "CHNP" ~ "#9EBE91",
                           color == "CHONP" ~ "#D1C74C",
                           color == "CHOP" ~ "#E4B80E",
                           color == "uncharacterized" ~ "#F21A00",
                           color == "CH" ~ "#E67D00",
                           color == "CHOS" ~ "goldenrod3",
                           color == "CHONS" ~ "goldenrod4",
                           is.na(color) ~ "red",
                           TRUE ~ as.character(color)),
         Timepoint = case_when(Timepoint == "T0" ~ "Exudate"))%&gt;%
  left_join(labile_inchi_classified, by = "feature_number")



# labile_RA$`chemical composition` &lt;- factor(labile_RA$`chemical composition`, 
#                                                 levels = c("", "CH", "CHOP", "CHONP", 
#                                                            "CHNP", "CHON", "CHN", "CHO", "CHOS", 
#                                                            "CHONS", "uncharacterized"))
# 
# lcolors &lt;- labile_RA$color
# 
# names(lcolors) &lt;- labile_RA$`chemical composition`


pdf("~/Documents/GitHub/DORCIERR/data/plots/labile_compound_composition.pdf")
labile_RA%&gt;%
  # filter(Organism == "Pocillopora verrucosa")%&gt;%
  ggplot(., aes(x = Organism, y= ra)) +
  geom_bar(aes(fill = inchi_3), stat = "summary", fun.y = "mean", position = "stack") +
  # scale_fill_manual(values= lcolors) +
  # scale_y_continuous(limits = c(0,17.5), breaks= c(2.5, 5, 7.5, 10, 12.5, 15, 17.5)) +
theme(
  axis.text.x = element_text(angle = 60, hjust = 1),
  panel.background = element_rect(fill = "transparent"), # bg of the panel
  plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
  panel.grid.major.x = element_blank(), # get rid of major grid
  panel.grid.major.y = element_line(colour = "grey"),
  panel.grid.minor = element_blank(), # get rid of minor grid
  legend.background = element_rect(fill = "transparent"), # get rid of legend bg
  legend.box.background = element_rect(fill = "transparent") # get rid of legend panel bg
) +
  facet_wrap(~DayNight) +
  xlab("Organism") + 
  ylab("Relative Abundance")
dev.off()

labile_RA%&gt;%
  filter(NOSC &lt; 4 &amp; NOSC &gt; -4)%&gt;%
  ggplot(., aes(x = Organism, y =NOSC)) +
  # geom_boxplot(stat = "boxplot", outlier.colour = "red") +
  geom_bar(stat = "summary", fun.y = "mean") +
  # geom_bar(aes(fill = `level 3`), stat = "summary", fun.y = "mean", position = "stack") +
  # scale_fill_manual(values= lcolors) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major.x = element_blank(), # get rid of major grid
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent") # get rid of legend panel bg
  ) +
  facet_wrap(~DayNight) +
  xlab("Organism") + 
  ylab("NOSC")

 
# GRAPHING -- Labile accummulite ------------------------------------------
# labile_accumulite &lt;- as.vector(combined_labile_accumulites_compounds$feature_number)
# 
# labile_accumulite_RA &lt;- feature_RA%&gt;%
#   dplyr::select(c(1:5, labile_accumulite))%&gt;%
#   gather(feature_number, RA, 6:ncol(.))%&gt;%
#   filter(DayNight == "Day",
#          Timepoint == "T0")
# 
# 
# labile_accumulite_RA_meta_full &lt;- left_join(labile_accumulite_RA, combined_labile_accumulites_compounds%&gt;%
#                                               filter(!Organism == "algae",
#                                                      !Organism == "fleshy",
#                                                      !Organism == "primaryproducers")%&gt;%
#                                               unite(tag, c(Organism, Lability), sep = "_")%&gt;%
#                                               dplyr::select(1:29), 
#                                             by = "feature_number")%&gt;%
#   rename(`chemical composition` = simplified_makeup)%&gt;%
#   add_column(color = .$`chemical composition`)%&gt;%
#   mutate(color = case_when(color == "CHO" ~ "darkblue",
#                            color == "CHON" ~ "#3B9AB2",
#                            color == "CHN" ~ "darkslatergray2", #Change color to something else
#                            color == "CHNP" ~ "#9EBE91",
#                            color == "CHONP" ~ "#D1C74C",
#                            color == "CHOP" ~ "#E4B80E",
#                            color == "" ~ "#F21A00",
#                            color == "CH" ~ "#E67D00", 
#                            TRUE ~ as.character(color)))%&gt;%
#   separate(tag, c("Organism-ish", "Lability"), sep = "_")
# 
# l_t0 &lt;- labile_accumulite_RA_meta_full%&gt;%
#   filter(Timepoint == "T0" ,
#          Lability == "labile")
# 
# a_tf &lt;- labile_accumulite_RA_meta_full%&gt;%
#   filter(Timepoint == "T0",
#          Lability == "accumulite")
# 
# labile_accumulite_RA_meta &lt;- bind_rows(l_t0, a_tf)%&gt;%
#   mutate(Lability = case_when(Lability == "labile" ~ "Labile Exudate",
#                               Lability == "accumulite" ~ "Microbial Accumulite",
#                               TRUE ~ as.character(Lability)))
# 
# labile_accumulite_RA_meta$Lability &lt;- factor(labile_accumulite_RA_meta$Lability, levels = c("Labile Exudate", "Microbial Accumulite"))
# 
# labile_accumulite_RA_meta$`chemical composition` &lt;- factor(labile_accumulite_RA_meta$`chemical composition`, 
#                                                            levels = c("", "CH", "CHOP", "CHONP", "CHNP", "CHON", "CHN", "CHO"))
# 
# lacolors &lt;- labile_accumulite_RA_meta$color
# 
# names(lacolors) &lt;- labile_accumulite_RA_meta$`chemical composition`
# 
# pdf("all_plots.pdf", height = 5, width = 7)
# labile_accumulite_RA_meta%&gt;%
#   split(list(.$`Organism-ish`))%&gt;%
#   map(~ggplot(., aes(x = Organism, y= (RA*100), fill = `chemical composition`)) +
#         geom_bar(stat = "summary", fun.y = "sum") +
#         scale_fill_manual(values= lacolors)+
#         ggtitle(unique(.$`Organism-ish`)) +
#         theme(
#           axis.text.x = element_text(angle = 60, hjust = 1),
#           panel.background = element_rect(fill = "transparent"), # bg of the panel
#           plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
#           panel.grid.major = element_blank(), # get rid of major grid
#           panel.grid.minor = element_blank(), # get rid of minor grid
#           legend.background = element_rect(fill = "transparent"), # get rid of legend bg
#           legend.box.background = element_rect(fill = "transparent") # get rid of legend panel bg
#         ) +
#         facet_wrap(~Lability) +
#         xlab("Canopus Level 3") + 
#         ylab("Relative Abundance (percent)"))
# dev.off()



# GRAPHING -- Significant microbes ----------------------------------------
sig_genera &lt;- dunnett_micro_analysis%&gt;%
  filter(microbe_organism != "Primary Producers",
         microbe_organism != "Corraline",
         microbe_organism != "Fleshy Algae",
         microbe_organism != "Cosmo")%&gt;%
  rename(Organism = microbe_organism)%&gt;%
  left_join(., microbe_no_rare, by = c("OTU", "DayNight", "Organism"), suffix = c("_x", "_y"))%&gt;%
  inner_join(., ra_bigger_TF, by = c("OTU", "DayNight", "Organism"))%&gt;%
  left_join(microbe_taxonomy, by = "OTU")%&gt;%
  separate(Taxonomy, c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "OTU_id"), sep = ";", remove = FALSE)

pdf("~/Documents/GitHub/DORCIERR/data/plots/sig_microbes.pdf", height = 5, width = 11)
sig_genera%&gt;%
  unite(genera, c("Family", "Genus"), sep = " ")%&gt;%
  ggplot(., aes(Organism, ra, fill = genera)) +
  geom_bar(stat = "summary", fun.y = "mean", position = "stack") +
  theme(
    # legend.position = "none",
    # plot.margin = margin(2,.8,2,.8, "cm"),
    axis.text.x = element_text(angle = 60, hjust = 1),
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent")
    # legend.position = "none"# get rid of legend panel bg
  ) +
  facet_wrap(~ DayNight) +
  ylab("Relative Abundance")
dev.off()


# GRAPHING -- Microbes cosmo, algal, coral --------------------------------
sig_genera_cosmo &lt;- dunnett_micro_analysis%&gt;%
  filter(microbe_organism %like any% c("Primary Producers", "Corraline", "Felshy Algae", "Cosmo"))%&gt;%
  left_join(., microbe_no_rare, by = c("OTU", "DayNight"), suffix = c("_x", "_y"))%&gt;%
  inner_join(., ra_bigger_TF%&gt;% select(-Organism), by = c("OTU", "DayNight"))%&gt;%
  left_join(microbe_taxonomy, by = "OTU")%&gt;%
  separate(Taxonomy, c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "OTU_id"), sep = ";", remove = FALSE)

pdf("~/Documents/GitHub/DORCIERR/data/plots/sig_microbes_cosmo.pdf", height = 7, width = 13)
sig_genera_cosmo%&gt;%
  unite(genera, c("Family", "Genus"), sep = " ")%&gt;%
  ggplot(., aes(Organism, ra, fill = genera)) +
  geom_bar(stat = "summary", fun.y = "mean", position = "stack") +
  scale_y_continuous(minor_breaks = seq(0, 0.8, 0.5), breaks = seq(0, .8, .1)) +
  # scale_fill_continuous(values = wes_palette("zissou1", n = 32)) +
  theme(
    # legend.position = "none",
    # plot.margin = margin(2,.8,2,.8, "cm"),
    axis.text.x = element_text(angle = 60, hjust = 1),
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major = element_blank(), # get rid of major grid
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent")
    # legend.position = "none"# get rid of legend panel bg
  ) +
  facet_wrap(~ DayNight) +
  ylab("Relative Abundance")
dev.off()


# GRAPHING -- FCM data ----------------------------------------------------
fcm_graphing &lt;- fcm_wdf%&gt;%
  filter(!Organism == 'Influent',
         !Organism == 'Offshore')

pdf("~/Documents/GitHub/DORCIERR/data/plots/fcm_DayNight.pdf", width = 7, height = 5)
fcm_graphing%&gt;%
  ggplot(aes(x= Timepoint, y = `Cells µL-1`, color = Organism))+
                       geom_point(stat = "summary", fun.y = "mean") +
                       geom_line(aes(group = Organism), stat = "summary", fun.y = "mean") +
                       facet_wrap(~DayNight) +
  scale_y_continuous(limits = c(0,900), breaks= seq(0, 900, 100)) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major.x = element_blank(), # get rid of major grid
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent") # get rid of legend panel bg
  )
dev.off()
  

# GRAPHING -- correlation_microbe_labile ----------------------------------
# correlation_microbe_labile%&gt;%
#   ggplot(aes(x = microbe_asin, y = feature_asin))+
#   geom_point()

# hc_df%&gt;%
#   gather(microbe, microbe_zscore, contains(";"))%&gt;%
#   gather(feature, feature_zscore, 2:(ncol(.)-2))%&gt;%
#   separate(sample, c("Organism", "DayNight", "Replicate"), sep = "_")%&gt;%
#   group_by(Organism, DayNight, microbe, feature)%&gt;%
#   summarize_if(is.numeric, mean)%&gt;%
#   ungroup()%&gt;%
#   filter(microbe_zscore &gt; 1 | microbe_zscore &lt; -1,
#          feature_zscore &gt; 1 | feature_zscore &lt; -1)%&gt;%
#   ggplot(aes(x = microbe_zscore, y = feature_zscore, col = feature, shape = DayNight))+
#   geom_point() +
#   geom_line(stat = "summary", fun.y = "mean") +
#   # theme(legend.text = element_blank()) +
#   facet_wrap(~microbe)


# GRAPHING -- Feature XIC and DOC -----------------------------------------
sample_tic &lt;- feature_xic%&gt;%
  group_by(Organism, Replicate, Timepoint, DayNight)%&gt;%
  summarize_if(is.numeric, sum)

doc_biplot &lt;- dom_stats_wdf%&gt;%
  filter(feature_number == "DOC")%&gt;%
  group_by(Organism, Replicate, Timepoint, DayNight)%&gt;%
  summarize_if(is.numeric, mean, na.rm = TRUE)%&gt;%
  left_join(sample_tic, by = c("Organism", "Replicate", "Timepoint", "DayNight"))%&gt;%
  unite(sample, c(Organism, Replicate), sep = "_")

pdf("~/Documents/GitHub/DORCIERR/data//plots/doc_biplot.pdf", width = 6, height = 5)
ggplot(doc_biplot, aes(x = sample, y= asin, col = Timepoint))+
  geom_point(stat = "identity", position = position_dodge2(width = 1)) +
  facet_wrap(~DayNight) +
  ylim(1.7,2) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    panel.background = element_rect(fill = "transparent"), # bg of the panel
    plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
    panel.grid.major.x = element_blank(), # get rid of major grid
    panel.grid.major.y = element_line(colour = "grey"),
    panel.grid.minor = element_blank(), # get rid of minor grid
    legend.background = element_rect(fill = "transparent"), # get rid of legend bg
    legend.box.background = element_rect(fill = "transparent") # get rid of legend panel bg
  )

ggplot(doc_biplot, aes(sample, xic, fill = Timepoint))+
  geom_bar(stat = "identity", position = position_dodge2(width = 1)) +
  facet_wrap(~DayNight) +
    theme(
      axis.text.x = element_text(angle = 60, hjust = 1),
      panel.background = element_rect(fill = "transparent"), # bg of the panel
      plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
      panel.grid.major.x = element_blank(), # get rid of major grid
      panel.grid.major.y = element_line(colour = "grey"),
      panel.grid.minor = element_blank(), # get rid of minor grid
      legend.background = element_rect(fill = "transparent"), # get rid of legend bg
      legend.box.background = element_rect(fill = "transparent") # get rid of legend panel bg
    )
dev.off()


# WRITING -- Dataframe for Cytoscape ------------------------------
day_organism_mean &lt;- feature_RA%&gt;%
  filter(DayNight == "Day")%&gt;%
  dplyr::select(-c("Replicate", "Experiment"))%&gt;%
  unite(sample, c("Organism", "Timepoint"), sep = "_", remove = TRUE)%&gt;%
  group_by(sample)%&gt;%
  summarize_if(is.numeric, mean)%&gt;%
  ungroup()%&gt;%
  gather(feature_number, RA, 2:ncol(.))%&gt;%
  spread(sample, RA)

organism_mean_networking &lt;- right_join(networking, day_organism_mean, by = "feature_number")

microbial_accumulites_cyto &lt;- microbial_accumulites%&gt;%
  dplyr::select(1:3)%&gt;%
  spread(Organism, p_value.time)

labile_exudates_cyto &lt;- combined_labile_compounds%&gt;%
  dplyr::select(-c(2:37))

meta_stats_cyto &lt;- full_join(labile_exudates_cyto, microbial_accumulites_cyto, by = "feature_number", suffix = c(".labile", "accumulite"))

cyto_file&lt;- left_join(organism_mean_networking, meta_stats_cyto, by = "feature_number")%&gt;%
  rename(shared_name = feature_number)

write_csv(cyto_file, "~/Documents/GitHub/DORCIERR/data/plots/Day_Dorc_cytoscape.csv")

# WRITING —- Two-Way ANOVA Significance table  -----------------------------
write_csv(two_way_signignificant, "~/Documents/GitHub/DORCIERR/data/analysis/Dorcierr_two_way_significant.csv")

# WRITING —- Metastats combined tables -------------------------------------
write_csv(combined_labile_compounds, "~/Documents/GitHub/DORCIERR/data/analysis/combined_labile_compounds.csv")

# write_csv(combined_accumulite_compounds, "./staring_at_data/combined_accumulite_compounds.csv")

# write_csv(combined_labile_accumulites_compounds, "./staring_at_data/combined_accumulating_labile_compounds.csv")

# write_csv(cca_labile_accumulites, "./staring_at_data/cca_labile_accumulites.csv")

# write_csv(level_2, "./Labile_table_figure/level_2.csv")

# write_csv(organism_labile_level, "./Labile_table_figure/Organism_labile_table.csv")

# WRITING —- dataframes for graphing ---------------------------------------
write_csv(pco_all, "~/Documents/GitHub/DORCIERR/data/plots/PCo_scores.dat")
write_csv(fcm_graphing, "~/Documents/GitHub/DORCIERR/data/plots/fcm_graphing.dat")
write_csv(tukey_model_fcm, "~/Documents/GitHub/DORCIERR/data/plots/fcm_stats.dat")
write_csv(labile_RA, "~/Documents/GitHub/DORCIERR/data/plots/labile_graphing.dat")
write_csv(sig_genera, "~/Documents/GitHub/DORCIERR/data/plots/sig_microbes.dat")


</code></pre></div></div>


<ul class="taxonomy__index">
  
  
</ul>





  </div>
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    <ul class="author__urls social-icons">
      
        
          
            <li><a href="" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">Website</span></a></li>
          
        
          
            <li><a href="https://www.twitter.com/zquinlan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://www.researchgate.net/profile/zachary-quinlan" rel="nofollow noopener noreferrer"><i class="fab fa-researchgate" aria-hidden="true"></i><span class="label">ResearchGate</span></a></li>
          
        
          
            <li><a href="https://github.com/zquinlan" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
          
        
          
            <li><a href="https://orcid.org/" rel="nofollow noopener noreferrer"><i class="fab fa-orcid" aria-hidden="true"></i><span class="label">OrcID</span></a></li>
          
        
      

    
      <li><a href="/%7B%7B%20site.baseurl%20%7D%7D/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 Zach Quinlan. Powered by <a href = "https://zquinlan.github.io/acio">AcIo</a> &amp; <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/%7B%7B%20site.baseurl%20%7D%7D/assets/js/main.min.js"></script>










  </body>
</html>
